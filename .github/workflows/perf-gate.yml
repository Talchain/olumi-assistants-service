name: Performance Gate

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: perf-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  perf-gate:
    name: Performance Gate (p95 < 8s)
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      BASE_URL: https://olumi-assistants-service.onrender.com
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with: { version: 9 }

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run Artillery against production (always write JSON)
        env:
          ASSIST_API_KEY: ${{ secrets.ASSIST_API_KEY }}
          BASE_URL: ${{ env.BASE_URL }}
        run: |
          set -euxo pipefail
          npx --yes artillery@2 run perf/perf.yml -o perf-results.json || echo "ARTILLERY_FAILED=1" >> $GITHUB_ENV
          # Ensure artefact presence even if Artillery failed early
          [[ -f perf-results.json ]] || echo '{}' > perf-results.json

      - name: Enforce p95 < 8000ms on /healthz
        run: |
          node -e "
          const fs=require('fs');
          const p=JSON.parse(fs.readFileSync('perf-results.json','utf8'));
          // Try common Artillery shapes
          const agg = p.aggregate || p.aggregates || {};
          let p95;
          // Prefer scenario-specific latency when available
          const s = (p.intermediate || []).find(x => x.name === 'healthz_gating');
          if (s?.summaries?.http?.latency?.p95) p95 = s.summaries.http.latency.p95;
          if (!p95 && agg.latency?.p95) p95 = agg.latency.p95;
          if (!p95 && agg.http?.latency?.p95) p95 = agg.http.latency.p95;
          if (!p95) throw new Error('p95 not found in perf-results.json for healthz_gating');
          console.log('healthz p95:', p95, 'ms');
          if (p95 > 8000) { throw new Error(\`p95 \${p95}ms > 8000ms\`); }
          "

      - name: Summarise p95 (healthz + draft-graph if present)
        run: |
          node -e "
          const fs=require('fs');
          const p=JSON.parse(fs.readFileSync('perf-results.json','utf8'));
          const rows=[];
          function pickP95(name){
            const i=(p.intermediate||[]).find(x=>x.name===name);
            return i?.summaries?.http?.latency?.p95 ?? null;
          }
          const healthz=pickP95('healthz_gating');
          const draft=pickP95('draft_graph_observe');
          rows.push(['Scenario','p95 (ms)']);
          rows.push(['healthz_gating', healthz ?? 'n/a']);
          rows.push(['draft_graph_observe (non-blocking)', draft ?? 'n/a']);
          const md = [
            '### Performance Gate Summary',
            '',
            '| Scenario | p95 (ms) |',
            '|---|---|',
            ...rows.slice(1).map(r=>\`| \${r[0]} | \${r[1]} |\`)
          ].join('\n');
          fs.writeFileSync(process.env.GITHUB_STEP_SUMMARY, md);
          "

      - name: Upload perf artefact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-results
          path: perf-results.json

      - name: Comment p95 on PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Performance Gate (production):**
            Results uploaded as artefact **perf-results**.
            See job summary for p95 values (healthz gating, draft-graph observed).
