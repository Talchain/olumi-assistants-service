openapi: 3.0.3
info:
  title: Olumi Assistants Service API
  version: 1.11.1
  description: |
    AI-powered decision graph drafting service that transforms natural language briefs into structured,
    executable decision models with provenance tracking and validation.

    ## Features
    - **Structured Provenance**: Traceable citations to source documents with locations
    - **Streaming Support**: Server-Sent Events (SSE) for real-time progress updates
    - **LLM-Guided Repair**: Intelligent graph validation and auto-repair
    - **Security Rails**: Rate limiting, body size limits, request timeouts
    - **Deprecation Signals**: Migration support for legacy provenance formats

  contact:
    name: Olumi API Support
    url: https://docs.olumi.ai
    email: support@olumi.ai
  license:
    name: Proprietary

servers:
  - url: http://localhost:3101
    description: Local development
  - url: https://api.olumi.ai
    description: Production

tags:
  - name: Draft
    description: Graph drafting endpoints
  - name: Suggest
    description: Option suggestion endpoints
  - name: Explain
    description: Explanation and rationale endpoints
  - name: Health
    description: Service health check

paths:
  /healthz:
    get:
      summary: Health check
      description: |
        Returns service health status and configuration info.

        **Use for ops visibility:**
        - Service status and version
        - LLM provider and model configuration
        - Active feature flags (environment-level)
        - Graph limits source (engine vs config)
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - ok
                  - service
                  - version
                  - provider
                  - model
                  - limits_source
                  - feature_flags
                properties:
                  ok:
                    type: boolean
                    example: true
                  service:
                    type: string
                    example: "assistants"
                  version:
                    type: string
                    description: Service version (semver)
                    example: "1.1.0"
                  provider:
                    type: string
                    description: LLM provider in use
                    enum: [openai, anthropic, fixtures]
                    example: "anthropic"
                  model:
                    type: string
                    description: LLM model identifier
                    example: "claude-3-5-sonnet-20241022"
                  limits_source:
                    type: string
                    enum: [engine, config]
                    description: Where graph limits are sourced from
                  feature_flags:
                    type: object
                    description: Current feature flag values (environment-level)
                    properties:
                      grounding:
                        type: boolean
                        description: Document grounding enabled
                      critique:
                        type: boolean
                        description: Critique endpoint enabled
                      clarifier:
                        type: boolean
                        description: Clarifying questions enabled
                    example:
                      grounding: true
                      critique: true
                      clarifier: true

  /assist/draft-graph:
    post:
      summary: Draft decision graph (JSON or SSE)
      description: |
        Generates a decision graph from a natural language brief with optional document attachments.

        **Response Format:**
        - Default (JSON): Returns complete graph immediately
        - SSE: Include `Accept: text/event-stream` header for streaming updates

        **Note:** Use `/assist/draft-graph/stream` for dedicated SSE endpoint with better caching.
      tags:
        - Draft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftGraphInput'
            examples:
              basic:
                summary: Basic brief
                value:
                  brief: "Should we expand to international markets or focus on domestic growth?"
              with_attachments:
                summary: With document attachments
                value:
                  brief: "Based on the attached market analysis, develop a comprehensive growth strategy"
                  attachments:
                    - id: "doc_1"
                      kind: "pdf"
                      name: "market-analysis.pdf"
                  attachment_payloads:
                    doc_1: "base64encodedcontent..."
      responses:
        '200':
          description: Graph successfully generated
          headers:
            X-Deprecated-Provenance-Format:
              description: Present if graph contains legacy string provenance
              schema:
                type: string
                enum: ["true"]
            X-Deprecation-Sunset:
              description: Date when legacy format will be removed (if X-Deprecated-Provenance-Format present)
              schema:
                type: string
                format: date
                example: "2025-12-01"
            X-Deprecation-Link:
              description: Link to migration guide (if X-Deprecated-Provenance-Format present)
              schema:
                type: string
                format: uri
                example: "https://docs.olumi.ai/provenance-migration"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftGraphOutput'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEStream'
              example: |
                event: stage
                data: {"stage":"DRAFTING"}

                event: stage
                data: {"stage":"DRAFTING","payload":{"graph":{...},"patch":{...},"confidence":0.5}}

                event: stage
                data: {"stage":"COMPLETE","payload":{"graph":{...},"patch":{...},"confidence":0.87}}
        '400':
          $ref: '#/components/responses/BadInput'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /assist/draft-graph/stream:
    post:
      summary: Draft decision graph (SSE only)
      description: |
        Dedicated streaming endpoint that always returns Server-Sent Events (SSE).

        **Benefits over `/assist/draft-graph` with Accept header:**
        - Explicit URL for preflighting and caching
        - Clearer API surface
        - Better CDN/proxy support

        **Streaming Behavior:**
        - Initial `DRAFTING` event sent immediately
        - Fixture graph shown after 2.5s if LLM is still processing
        - Final `COMPLETE` event contains actual graph
      tags:
        - Draft
      requestBody:
        $ref: '#/components/requestBodies/DraftGraphRequest'
      responses:
        '200':
          description: SSE stream with graph generation progress
          headers:
            X-Deprecated-Provenance-Format:
              $ref: '#/components/headers/X-Deprecated-Provenance-Format'
            X-Deprecation-Sunset:
              $ref: '#/components/headers/X-Deprecation-Sunset'
            X-Deprecation-Link:
              $ref: '#/components/headers/X-Deprecation-Link'
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEStream'
              examples:
                successful_stream:
                  summary: Successful graph generation
                  value: |
                    event: stage
                    data: {"stage":"DRAFTING"}

                    event: stage
                    data: {"stage":"COMPLETE","payload":{"graph":{"version":"1","nodes":[...],"edges":[...]},"confidence":0.87}}

                with_fixture:
                  summary: Slow response with fixture fallback
                  value: |
                    event: stage
                    data: {"stage":"DRAFTING"}

                    event: stage
                    data: {"stage":"DRAFTING","payload":{"graph":{"meta":{"source":"fixtures"}...},"confidence":0.5}}

                    event: stage
                    data: {"stage":"COMPLETE","payload":{"graph":{"meta":{"source":"assistant"}...},"confidence":0.92}}
        '400':
          description: Invalid input (SSE error format)
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEErrorStream'
        '429':
          $ref: '#/components/responses/RateLimited'

  /assist/suggest-options:
    post:
      summary: Suggest strategic options for a goal
      description: |
        Generates 3-5 distinct strategic options for a given goal.

        **Features:**
        - Deterministic ordering (options sorted alphabetically by ID)
        - Optional constraint consideration
        - Can avoid duplicating existing options
        - Returns structured options with IDs, titles, and descriptions
      tags:
        - Suggest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuggestOptionsInput'
            examples:
              basic:
                summary: Basic goal
                value:
                  goal: "Increase customer retention"
              with_constraints:
                summary: With constraints and existing options
                value:
                  goal: "Reduce operational costs"
                  constraints:
                    budget: 100000
                    timeline: "Q1 2025"
                  graph_summary:
                    decision: "dec_1"
                    existing_options: ["Outsource IT", "Automate workflows"]
      responses:
        '200':
          description: Options successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestOptionsOutput'
        '400':
          $ref: '#/components/responses/BadInput'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /assist/explain-diff:
    post:
      summary: Explain changes in a graph patch
      description: |
        Generates rationales explaining why specific changes were made in a graph patch.

        **Features:**
        - Non-mutating (does not modify the graph)
        - Deterministic ordering (rationales sorted alphabetically by target)
        - Structured output with target IDs, explanations, and optional provenance
        - Requires at least one change in the patch
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainDiffInput'
            examples:
              basic:
                summary: Explain added nodes
                value:
                  patch:
                    adds:
                      nodes:
                        - id: "opt_premium"
                          kind: "option"
                          label: "Premium pricing strategy"
                      edges: []
                    updates: []
                    removes: []
                  brief: "We need to increase revenue while maintaining customer satisfaction"
              with_summary:
                summary: With graph context
                value:
                  patch:
                    adds:
                      nodes:
                        - id: "out_revenue"
                          kind: "outcome"
                          label: "Revenue impact +15%"
                      edges:
                        - from: "opt_premium"
                          to: "out_revenue"
                    updates: []
                    removes: []
                  brief: "Analyze pricing strategy impact"
                  graph_summary:
                    node_count: 8
                    edge_count: 10
      responses:
        '200':
          description: Rationales successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainDiffOutput'
        '400':
          $ref: '#/components/responses/BadInput'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /assist/v1/draft-graph:
    post:
      summary: Draft decision graph (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Draft My Model** endpoint.

        This endpoint drafts a decision graph from a natural language brief using
        the engine's canonical GraphV1 / GraphPatchV1 contracts and the CEE
        validation pipeline. The underlying graph and patch payloads are the
        same engine contracts used by `/assist/draft-graph`; CEE adds trace,
        quality, validation metadata and archetype classification on top.

        **Rate limiting (CEE‑specific):**
        - Default: 5 requests per 60 seconds per API key (or client IP fallback).
        - Configurable via `CEE_DRAFT_RATE_LIMIT_RPM`.
        - Exceeding this per‑feature limit returns `CEEErrorResponseV1` with
          `code="CEE_RATE_LIMIT"`, `retryable=true`, a `Retry-After` header,
          and `details.retry_after_seconds` describing when it is safe to retry.
      tags:
        - Draft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEDraftGraphRequestV1'
      responses:
        '200':
          description: Graph successfully generated (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Draft My Model feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEDraftGraphResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Draft My Model
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/draft-graph/stream:
    post:
      summary: Draft decision graph with SSE streaming (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Draft My Model** endpoint with
        Server-Sent Events (SSE) streaming support.

        This endpoint provides real-time streaming of the draft generation process,
        allowing clients to display progress updates as the graph is being created.
        It uses the same CEE validation pipeline as `/assist/v1/draft-graph` including:
        - Single goal enforcement
        - Preflight brief readiness assessment
        - Clarification enforcement
        - Full graph validation and repair

        **SSE Events:**
        - `stage: DRAFTING` - Initial event indicating draft generation has started
        - `stage: COMPLETE` - Final event containing the complete response payload
        - `resume` - Resume token for connection recovery (if Redis available)
        - Heartbeat comments every 10 seconds to keep connection alive

        **Rate limiting (CEE‑specific):**
        - Default: 20 requests per 60 seconds per API key (or client IP fallback).
        - Configurable via `CEE_STREAM_RATE_LIMIT_RPM`.
        - Exceeding this limit returns an SSE error event with `CEE_RATE_LIMIT`.

        **Degraded Mode:**
        - If Redis is unavailable, streaming continues but without resume/recovery support.
        - The `X-SSE-Degraded` header indicates degraded mode.
      tags:
        - Draft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEDraftGraphRequestV1'
      responses:
        '200':
          description: SSE stream of draft generation events
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Draft Stream feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
            X-SSE-Degraded:
              description: Present if SSE is operating in degraded mode (no Redis).
              schema:
                type: string
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Server-Sent Events stream. Each event has format:
                  ```
                  event: stage
                  data: {"stage": "DRAFTING"|"COMPLETE", "payload": <CEEDraftGraphResponseV1>}
                  ```
        '400':
          description: CEE validation error (SSE format)
          content:
            text/event-stream:
              schema:
                type: string
        '429':
          description: CEE rate limit exceeded (SSE format)
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            text/event-stream:
              schema:
                type: string

  /assist/v1/decision-review/example:
    get:
      summary: Example Decision Review payload (CEE v1, internal)
      description: |
        Internal example endpoint exposing a frozen CEE Decision Review v1 payload
        for engine/PLoT documentation and testing. This path is authenticated via
        the standard API key mechanism and returns a static, metadata-only payload.

        This endpoint is intended for documentation, SDK alignment, and ops tooling
        only. It is not a primary product surface for Scenario UI.
      tags:
        - Explain
      x-internal: true
      responses:
        '200':
          description: Example CEE Decision Review Bundle (story/journey/uiFlags)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CeeDecisionReviewBundle'

  /assist/v1/team-perspectives:
    post:
      summary: Summarise team perspectives on a decision (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Team Perspectives** endpoint.

        This endpoint takes structured team stances (for/against/neutral) and
        returns a compact numeric summary of agreement vs disagreement. It does
        **not** process or return any free-text comments.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEETeamPerspectivesRequestV1'
      responses:
        '200':
          description: Team perspectives summarised (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Team Perspectives feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEETeamPerspectivesResponseV1'

  /assist/v1/health:
    get:
      summary: Summarise CEE service health (v1)
      description: |
        Returns a compact, metadata-only summary of CEE service health derived from
        the existing `/healthz` and CEE diagnostics surfaces.

        This endpoint is authenticated and intended for backend or ops consumers
        that already integrate with other `/assist/v1/*` routes.

        Note: This endpoint is not rate-limited.
      tags:
        - Health
      responses:
        '200':
          description: CEE service health summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CeeServiceHealthSummaryV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/sensitivity-coach:
    post:
      summary: Suggest sensitivity directions for key drivers (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Sensitivity Coach** endpoint.

        This endpoint turns `InferenceResultsV1.explain.top_drivers` into a
        small, deterministic set of suggestions about which drivers to
        increase or decrease. It does **not** call any LLMs and only returns
        structured, ID-based suggestions.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEESensitivityCoachRequestV1'
      responses:
        '200':
          description: Sensitivity suggestions computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Sensitivity Coach feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEESensitivityCoachResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Sensitivity Coach
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/options:
    post:
      summary: Suggest structural decision options (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Options Helper** endpoint.

        This endpoint suggests structured decision options using simple,
        deterministic heuristics over the decision graph and optional
        archetype metadata. It does **not** call any LLMs and only returns
        structured suggestions.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEOptionsRequestV1'
      responses:
        '200':
          description: Options suggestions computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Options feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEOptionsResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Options
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/bias-check:
    post:
      summary: Analyse decision graph for potential biases (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Bias Checker** endpoint.

        This endpoint inspects a decision graph (and optional archetype
        metadata) using simple, deterministic heuristics to surface
        potential sources of bias. It does **not** call any LLMs and only
        returns structured findings.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEBiasCheckRequestV1'
      responses:
        '200':
          description: Bias findings computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Bias Checker feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEBiasCheckResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Bias Checker
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/graph-readiness:
    post:
      summary: Assess graph readiness for analysis (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Graph Readiness** endpoint.

        Evaluates a decision graph's readiness for running inference/analysis.
        Returns a readiness score (0-100), quality factor breakdown, and
        actionable recommendations. This endpoint is deterministic, does **not**
        call any LLMs, and targets sub-50ms latency.

        Use this before running analysis to guide users on graph quality improvements.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEGraphReadinessRequestV1'
      responses:
        '200':
          description: Readiness assessment computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Graph Readiness feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEGraphReadinessResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Graph Readiness
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/key-insight:
    post:
      summary: Generate key insight prose from ranked actions (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Key Insight** endpoint.

        Generates clean, human-readable prose summaries from decision analysis
        results. Takes ranked actions and optional drivers from PLoT inference
        and produces a headline, primary driver explanation, confidence statement,
        and optional caveat.

        This endpoint is deterministic, does **not** call any LLMs, and targets
        sub-50ms latency. All label sanitisation (removing question marks,
        prefixes, etc.) is handled automatically.

        Use this after running inference to generate clean narrative summaries
        for UI display.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEKeyInsightRequestV1'
      responses:
        '200':
          description: Key insight generated (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Key Insight feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEKeyInsightResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Key Insight
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/elicit-belief:
    post:
      summary: Convert natural language to probability (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Belief Elicitation** endpoint.

        Converts natural language probability expressions to normalized 0-1 values.
        Handles qualitative terms ("likely", "probably"), percentages ("70%", "about 80%"),
        fractions ("3 in 4", "1/2"), and ambiguous expressions that need clarification.

        This endpoint is deterministic, does **not** call any LLMs for known patterns,
        and targets sub-50ms latency. Ambiguous expressions return a clarifying question
        with clickable options for the user.

        Use this when eliciting belief values from users for priors or edge weights.
      tags:
        - Graph
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEElicitBeliefRequestV1'
      responses:
        '200':
          description: Belief elicited successfully (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Elicit Belief feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEElicitBeliefResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Elicit Belief
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/suggest-utility-weights:
    post:
      summary: Suggest importance weights for outcome nodes (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Utility Weight Suggestions** endpoint.

        Suggests relative importance weights for outcome nodes in a decision graph.
        Uses semantic analysis of node labels and decision context to infer priorities.
        Weights are normalized to sum to 1.0.

        This endpoint is deterministic, does **not** call any LLMs when semantic signals
        are clear, and targets sub-100ms latency. When applicable, provides alternative
        weighting schemes (e.g., risk-averse, growth-focused, balanced).

        Use this when users need help assigning utility weights to outcomes.
      tags:
        - Graph
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEUtilityWeightRequestV1'
      responses:
        '200':
          description: Utility weight suggestions generated (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Utility Weight feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEUtilityWeightResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Utility Weight
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/elicit-risk-tolerance:
    post:
      summary: Elicit user risk tolerance profile (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Risk Tolerance Elicitation** endpoint.

        Two modes of operation:
        - `get_questions`: Returns a questionnaire for assessing risk tolerance
        - `process_responses`: Processes user answers and returns a risk profile

        The risk profile includes:
        - Profile type: risk_averse, risk_neutral, or risk_seeking
        - Score (0-100) with breakdown by category
        - Recommended utility coefficient for decision analysis

        This endpoint is deterministic, does **not** call any LLMs, and targets
        sub-50ms latency. Questions are context-specific (product or business).

        Use this to calibrate utility functions based on stakeholder risk preferences.
      tags:
        - Graph
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEERiskToleranceRequestV1'
            examples:
              get_questions:
                summary: Get questions for product context
                value:
                  mode: get_questions
                  context: product
              process_responses:
                summary: Process user responses
                value:
                  mode: process_responses
                  context: product
                  responses:
                    - question_id: q1_feature_launch
                      option_id: q1_o2
                    - question_id: q2_mixed_results
                      option_id: q2_o2
      responses:
        '200':
          description: Risk tolerance assessment (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Risk Tolerance feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/CEERiskToleranceGetQuestionsResponseV1'
                  - $ref: '#/components/schemas/CEERiskToleranceProcessResponsesResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Risk Tolerance
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/suggest-edge-function:
    post:
      summary: Suggest edge function type (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Edge Function Suggestion** endpoint.

        Suggests non-linear edge function types based on pattern matching of node
        labels and relationship descriptions. Supports:
        - `linear` (default): Output scales proportionally with input
        - `diminishing_returns`: Initial inputs have strong effects that taper off
        - `threshold`: Output only activates after input reaches critical level
        - `s_curve`: Slow start, rapid middle growth, then saturation

        This endpoint is deterministic, does **not** call any LLMs, and targets
        sub-50ms latency. Use this to suggest appropriate edge functions for PLoT's
        non-linear edge modeling feature.
      tags:
        - Graph
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEEdgeFunctionSuggestionRequestV1'
            examples:
              cost_relationship:
                summary: Cost to quality relationship
                value:
                  edge_id: e1
                  source_node:
                    id: n1
                    label: Marketing spend
                    kind: option
                  target_node:
                    id: n2
                    label: Customer acquisition
                    kind: outcome
                  relationship_description: "Spending more on marketing leads to diminishing returns over time"
              threshold_relationship:
                summary: Compliance threshold
                value:
                  edge_id: e2
                  source_node:
                    id: n3
                    label: Security investment
                    kind: option
                  target_node:
                    id: n4
                    label: Regulatory compliance
                    kind: outcome
                  relationship_description: "Must meet minimum security threshold to achieve compliance"
      responses:
        '200':
          description: Edge function suggestion (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Edge Function Suggestion feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEEdgeFunctionSuggestionResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Edge Function Suggestion
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/evidence-helper:
    post:
      summary: Score evidence items (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Evidence Helper** endpoint.

        This endpoint scores evidence items with simple, deterministic
        strength and relevance signals that can be reused across CEE
        experiences. It does **not** inspect or log raw evidence content;
        only structured, non-PII metadata is used.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEEvidenceHelperRequestV1'
      responses:
        '200':
          description: Evidence strengths computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Evidence Helper feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEEvidenceHelperResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Evidence Helper
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/explain-graph:
    post:
      summary: Explain decision graph (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Explain My Model** endpoint.

        This endpoint provides a structured explanation of a decision graph
        using the engine's canonical `Graph` contract together with
        `InferenceResultsV1` (report.v1 alias). CEE adds trace, quality,
        validation metadata and a structured `explanation` object on top.

        For v1 this endpoint is deterministic and does not perform additional
        LLM calls; it derives explanations directly from the supplied
        inference payload.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEExplainGraphRequestV1'
      responses:
        '200':
          description: Explanation successfully generated (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Explain Graph feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEExplainGraphResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Explain Graph
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

components:
  schemas:
    DraftGraphInput:
      type: object
      required:
        - brief
      properties:
        brief:
          type: string
          minLength: 30
          maxLength: 5000
          description: Natural language description of the decision to model
          example: "Should we migrate to microservices or keep the monolith? Consider cost, team size, and time to market."
        attachments:
          type: array
          description: |
            Optional document attachments for context (PDF, CSV, TXT, MD).

            **Limits:**
            - Per-file: 5,000 characters maximum
            - Aggregate: 50,000 characters maximum across all files
            - Exceeding limits returns 400 BAD_INPUT with actionable hints
          items:
            $ref: '#/components/schemas/Attachment'
        attachment_payloads:
          type: object
          description: |
            Base64-encoded content for each attachment.

            **Format:**
            - String: Direct base64-encoded content
            - Object: `{data: string, encoding: "base64"}`

            Whitespace in base64 strings is automatically stripped during validation.
          additionalProperties:
            oneOf:
              - type: string
                description: Base64-encoded content
              - type: object
                properties:
                  data:
                    type: string
                  encoding:
                    type: string
                    default: base64
        constraints:
          type: object
          description: Optional constraints (reserved for future use)
          additionalProperties: true
        flags:
          type: object
          description: |
            Per-request feature flag overrides.

            **Available flags:**
            - `grounding`: Enable/disable document grounding (env: ENABLE_GROUNDING, default: true)
            - `critique`: Enable/disable critique endpoint (env: ENABLE_CRITIQUE, default: true)
            - `clarifier`: Enable/disable clarifying questions (env: ENABLE_CLARIFIER, default: true)

            **Priority:** Per-request flag > Environment variable > Default value

            **Example:** `{"flags": {"grounding": false}}` disables grounding for this request only
          additionalProperties:
            type: boolean
        include_debug:
          type: boolean
          description: Include debug information in response
          default: false
        previous_graph:
          $ref: '#/components/schemas/Graph'
          description: |
            Optional previous graph to refine instead of drafting from scratch.

            When `CEE_REFINEMENT_ENABLED=true` and this field is provided, CEE
            will treat the request as a refinement of the existing graph. The
            server may apply additional caps and summarisation when building the
            internal refinement prompt.
        refinement_mode:
          type: string
          description: Optional refinement strategy hint for the draft pipeline
          enum: [auto, expand, prune, clarify]
        refinement_instructions:
          type: string
          minLength: 1
          maxLength: 2000
          description: |
            Optional natural language instructions for how to refine the
            existing graph (e.g. "Add more risks and outcomes"). These
            instructions are treated as part of the draft prompt and are never
            logged or emitted in telemetry.
        preserve_nodes:
          type: array
          maxItems: 50
          description: |
            Optional list of node IDs that should be preserved during
            refinement. CEE will avoid removing or renaming these nodes when
            applying structural changes.
          items:
            type: string
            minLength: 1
        clarifier_response:
          type: object
          description: User's answer to a clarifying question from a previous round
          properties:
            question_id:
              type: string
              description: ID of the question being answered
            answer:
              type: string
              description: User's answer (text or selected option)
          required:
            - question_id
            - answer
        conversation_history:
          type: array
          description: Full Q&A history from previous clarification rounds
          items:
            type: object
            properties:
              question_id:
                type: string
              question:
                type: string
              answer:
                type: string
            required:
              - question_id
              - question
              - answer
        max_clarifier_rounds:
          type: integer
          minimum: 0
          maximum: 10
          default: 5
          description: Maximum clarification rounds (0 to skip clarifier)
      additionalProperties: false

    Attachment:
      type: object
      required:
        - id
        - kind
        - name
      properties:
        id:
          type: string
          description: Unique identifier for this attachment
          example: "doc_1"
        kind:
          type: string
          enum: [pdf, csv, txt, md]
          description: Document type
        name:
          type: string
          description: Original filename
          example: "market-analysis.pdf"

    DraftGraphOutput:
      type: object
      required:
        - graph
        - patch
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        patch:
          $ref: '#/components/schemas/GraphPatch'
        rationales:
          type: array
          description: Explanations for graph elements
          items:
            type: object
            properties:
              target:
                type: string
                description: Node or edge ID being explained
              why:
                type: string
                maxLength: 280
                description: Brief explanation
              provenance_source:
                type: string
                description: Optional citation source
        issues:
          type: array
          description: Validation warnings (if any)
          items:
            type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence score for the generated graph
          example: 0.87
        clarifier_status:
          type: string
          enum: [complete, max_rounds, confident]
          description: Whether clarification questions are needed
        debug:
          type: object
          description: Debug information (only if include_debug=true)
          properties:
            needle_movers:
              type: array
              description: Document preview metadata
              items:
                type: object

    SuggestOptionsInput:
      type: object
      required:
        - goal
      properties:
        goal:
          type: string
          minLength: 5
          description: The goal or objective to generate options for
          example: "Increase customer retention rate"
        constraints:
          type: object
          description: Optional constraints to consider when generating options
          additionalProperties: true
          example:
            budget: 100000
            timeline: "Q1 2025"
        graph_summary:
          type: object
          description: Optional context about existing graph state
          properties:
            decision:
              type: string
              description: Decision node ID
            existing_options:
              type: array
              items:
                type: string
              description: List of existing option labels to avoid duplicating
        include_debug:
          type: boolean
          description: Include debug information in response
          default: false
      additionalProperties: false

    SuggestOptionsOutput:
      type: object
      required:
        - options
      properties:
        options:
          type: array
          minItems: 3
          maxItems: 5
          description: Generated strategic options (sorted alphabetically by ID)
          items:
            type: object
            required:
              - id
              - title
              - description
            properties:
              id:
                type: string
                minLength: 1
                description: Unique identifier for this option
                example: "opt_premium_pricing"
              title:
                type: string
                minLength: 3
                maxLength: 120
                description: Short title for the option
                example: "Premium Pricing Strategy"
              description:
                type: string
                minLength: 10
                maxLength: 500
                description: Detailed description of the option
                example: "Increase prices by 20% while adding premium features and personalized support to justify the higher cost"

    ExplainDiffInput:
      type: object
      required:
        - patch
      properties:
        patch:
          type: object
          description: Graph patch containing changes to explain
          properties:
            adds:
              type: object
              description: Added nodes and edges
              properties:
                nodes:
                  type: array
                  items:
                    type: object
                  default: []
                edges:
                  type: array
                  items:
                    type: object
                  default: []
              default:
                nodes: []
                edges: []
            updates:
              type: array
              description: Updated nodes
              items:
                type: object
              default: []
            removes:
              type: array
              description: Removed node/edge IDs
              items:
                type: string
              default: []
        brief:
          type: string
          description: Optional context about what the user is trying to achieve
          example: "We need to reduce costs while maintaining quality"
        graph_summary:
          type: object
          description: Optional summary of the current graph state
          properties:
            node_count:
              type: number
              description: Total number of nodes in the graph
            edge_count:
              type: number
              description: Total number of edges in the graph
      additionalProperties: false

    ExplainDiffOutput:
      type: object
      required:
        - rationales
      properties:
        rationales:
          type: array
          minItems: 1
          description: Explanations for each change (sorted alphabetically by target)
          items:
            type: object
            required:
              - target
              - why
            properties:
              target:
                type: string
                description: Node or edge ID being explained
                example: "opt_premium"
              why:
                type: string
                maxLength: 280
                description: Brief explanation of why this change was made
                example: "Premium pricing aligns with the goal of increasing revenue while maintaining brand positioning"
              provenance_source:
                type: string
                description: Optional citation to source document that influenced this change
                example: "market-analysis.pdf page 3"

    Graph:
      type: object
      required:
        - version
        - nodes
        - edges
      properties:
        version:
          type: string
          default: "1"
          description: Graph schema version
        default_seed:
          type: number
          default: 17
          description: Random seed for deterministic execution
        nodes:
          type: array
          maxItems: 12
          description: Graph nodes (max 12)
          items:
            $ref: '#/components/schemas/Node'
        edges:
          type: array
          maxItems: 24
          description: Graph edges (max 24)
          items:
            $ref: '#/components/schemas/Edge'
        meta:
          type: object
          description: Graph metadata
          properties:
            roots:
              type: array
              items:
                type: string
              description: Root node IDs
            leaves:
              type: array
              items:
                type: string
              description: Leaf node IDs
            suggested_positions:
              type: object
              description: Layout hints for UI
              additionalProperties:
                type: object
                properties:
                  x:
                    type: number
                  y:
                    type: number
            source:
              type: string
              enum: [assistant, fixtures]
              description: Origin of this graph

    Node:
      type: object
      required:
        - id
        - kind
      properties:
        id:
          type: string
          minLength: 1
          description: Unique node identifier
          example: "goal_1"
        kind:
          type: string
          enum: [goal, decision, option, outcome, risk, action]
          description: Node type
        label:
          type: string
          description: Human-readable label
          example: "Increase revenue by 25%"
        body:
          type: string
          maxLength: 200
          description: Optional detailed description

    Edge:
      type: object
      required:
        - from
        - to
      properties:
        id:
          type: string
          description: Optional edge identifier
        from:
          type: string
          description: Source node ID
        to:
          type: string
          description: Target node ID
        weight:
          type: number
          description: Edge weight (impact magnitude)
        belief:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence in this connection
          example: 0.85
        provenance:
          oneOf:
            - $ref: '#/components/schemas/StructuredProvenance'
            - type: string
              description: Legacy string provenance (deprecated)
              deprecated: true
          description: Citation for this edge
        provenance_source:
          type: string
          enum: [document, metric, hypothesis, engine]
          description: Type of provenance source

    StructuredProvenance:
      type: object
      required:
        - source
        - quote
      properties:
        source:
          type: string
          minLength: 1
          description: Source identifier (filename, metric name, or "hypothesis")
          example: "market-analysis.pdf"
        quote:
          type: string
          maxLength: 100
          description: Short citation or statement
          example: "Revenue grew 23% YoY"
        location:
          type: string
          description: Specific location within source (e.g., "page 12", "row 42", "line 156")
          example: "page 12"

    GraphPatch:
      type: object
      description: Incremental graph changes (for diff view)
      properties:
        adds:
          type: object
          properties:
            nodes:
              type: array
              items:
                $ref: '#/components/schemas/Node'
            edges:
              type: array
              items:
                $ref: '#/components/schemas/Edge'
        updates:
          type: array
          items:
            type: object
        removes:
          type: array
          items:
            type: object

    InferenceResultsV1:
      type: object
      description: Engine inference results (alias for report.v1) used by CEE explain endpoints
      required:
        - summary
        - seed
        - response_hash
      properties:
        summary:
          type: string
          description: Short natural language summary of inference results
        explain:
          type: object
          description: Optional explanation details such as top drivers
          properties:
            top_drivers:
              type: array
              items:
                type: object
                properties:
                  node_id:
                    type: string
                  description:
                    type: string
                  contribution:
                    type: number
        model_card:
          type: object
          description: Optional engine/model metadata
          additionalProperties: true
        seed:
          type: string
          description: Seed used by the engine for this inference
        response_hash:
          type: string
          description: Engine-provided response hash for reproducibility

    CEETraceMeta:
      type: object
      description: Trace metadata for CEE responses
      properties:
        request_id:
          type: string
          description: Unique request identifier
        correlation_id:
          type: string
          description: Correlates to server logs and telemetry
        engine:
          type: object
          description: Engine-level trace information
          properties:
            provider:
              type: string
            model:
              type: string
            version:
              type: string
            response_hash:
              type: string
            degraded:
              type: boolean
        details:
          type: object
          description: Additional trace metadata
          additionalProperties: true

    CEEValidationIssue:
      type: object
      description: Validation issue discovered in the CEE pipeline
      required:
        - code
        - severity
      properties:
        code:
          type: string
        severity:
          type: string
          enum: [info, warning, error]
        field:
          type: string
          description: Optional field or path this issue relates to
        message:
          type: string
          description: Human-readable description for clients (not logged as telemetry)
        suggestion:
          type: string
          description: High-level suggestion for how to address this issue
        meta:
          type: object
          description: Additional machine-readable metadata for this issue
          additionalProperties: true
        details:
          type: object
          additionalProperties: true

    CEEGuidanceV1:
      type: object
      description: |
        High-level user guidance derived from quality, validation_issues, and (where applicable) response_limits.
        Intended for UI hints and summaries rather than core programmatic logic.
      required:
        - summary
      properties:
        summary:
          type: string
          description: Short overview of model quality and any notable limitations.
        risks:
          type: array
          description: Concise risk or gap statements derived from validation issues and truncation flags.
          items:
            type: string
        next_actions:
          type: array
          description: Suggested next actions to improve confidence in the decision.
          items:
            type: string
        any_truncated:
          type: boolean
          description: True if any truncation flag in response_limits is set.

    ErrorV1:
      type: object
      description: Generic error response schema for non-CEE endpoints and SSE helpers
      required:
        - schema
        - code
        - message
      properties:
        schema:
          type: string
          enum: [error.v1]
        code:
          type: string
          enum: [BAD_INPUT, RATE_LIMITED, INTERNAL]
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error context
          additionalProperties: true

    CEEQualityMeta:
      type: object
      description: Quality scores for CEE outputs (1-10 scale)
      required:
        - overall
      properties:
        overall:
          type: integer
          minimum: 1
          maximum: 10
        structure:
          type: integer
          minimum: 1
          maximum: 10
        causality:
          type: integer
          minimum: 1
          maximum: 10
        coverage:
          type: integer
          minimum: 1
          maximum: 10
        safety:
          type: integer
          minimum: 1
          maximum: 10
        issues_by_severity:
          type: object
          description: Aggregate counts of validation issues by severity
          properties:
            error:
              type: integer
            warning:
              type: integer
            info:
              type: integer
        details:
          type: object
          additionalProperties: true

    CEEErrorCode:
      type: string
      description: Machine-readable CEE error code
      enum:
        - CEE_TIMEOUT
        - CEE_RATE_LIMIT
        - CEE_GRAPH_INVALID
        - CEE_VALIDATION_FAILED
        - CEE_CLARIFICATION_REQUIRED
        - CEE_INTERNAL_ERROR
        - CEE_SERVICE_UNAVAILABLE
        - CEE_ENGINE_DEGRADED
        - CEE_REPRO_MISMATCH

    CEEErrorResponseV1:
      type: object
      description: Error response schema for CEE endpoints
      required:
        - schema
        - code
        - message
      properties:
        schema:
          type: string
          enum: [cee.error.v1]
        code:
          $ref: '#/components/schemas/CEEErrorCode'
        message:
          type: string
          description: Human-readable error message
        source:
          type: string
          description: Logical source of the error (always "cee" for CEE endpoints)
        request_id:
          type: string
          description: Stable request identifier for tracing and support
        degraded:
          type: boolean
          description: True when CEE or its dependencies are operating in degraded mode
        reason:
          type: string
          description: Short machine-friendly reason code (e.g. "empty_graph", "incomplete_structure")
        recovery:
          type: object
          description: High-level guidance on how to fix input or proceed
          properties:
            suggestion:
              type: string
              description: Single high-level suggestion for the user
            hints:
              type: array
              description: Concrete, short hints for remediation
              items:
                type: string
            example:
              type: string
              description: Optional example brief or graph description
        node_count:
          type: integer
          description: Graph node count when relevant to the error
        edge_count:
          type: integer
          description: Graph edge count when relevant to the error
        missing_kinds:
          type: array
          description: Node kinds missing from the graph for minimum-structure enforcement
          items:
            type: string
        retryable:
          type: boolean
          description: Whether the client may safely retry this request
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        details:
          type: object
          additionalProperties: true

    CEEDraftGraphRequestV1:
      allOf:
        - $ref: '#/components/schemas/DraftGraphInput'
        - type: object
          properties:
            seed:
              type: string
              description: Optional client-provided seed for deterministic behaviour
            archetype_hint:
              type: string
              description: Optional hint for the target archetype, e.g. pricing_decision

    CEEExplainGraphRequestV1:
      type: object
      description: CEE explain-graph request payload
      required:
        - graph
        - inference
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        inference:
          type: object
          required:
            - summary
            - seed
            - response_hash
          properties:
            summary:
              type: string
              description: Short summary of the inference run.
            explain:
              type: object
              description: Optional explainability metadata used to derive explanations.
              properties:
                top_drivers:
                  type: array
                  items:
                    type: object
                    required:
                      - node_id
                    properties:
                      node_id:
                        type: string
                      description:
                        type: string
                      contribution:
                        type: number
                  default: []
            model_card:
              type: object
              additionalProperties: true
              description: Optional model metadata blob.
            seed:
              type: string
            response_hash:
              type: string
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEEEvidenceItemRequestV1:
      type: object
      description: Evidence item provided by the client for strength scoring
      required:
        - id
        - type
      properties:
        id:
          type: string
          description: Opaque evidence identifier
        type:
          type: string
          description: Evidence kind (see enum for recommended values)
          enum: [experiment, user_research, market_data, expert_opinion, other]
        source:
          type: string
          description: Optional short source code (not logged in telemetry)
        content:
          type: string
          description: Optional raw evidence content (never logged or emitted in telemetry)
        observed_at:
          type: string
          format: date-time
          description: Optional ISO8601 timestamp when this evidence was observed or last updated

    CEEEvidenceItemResponseV1:
      type: object
      description: Evidence item with computed strength metadata
      required:
        - id
        - type
        - strength
      properties:
        id:
          type: string
        type:
          type: string
        strength:
          type: string
          enum: [none, weak, medium, strong]
        relevance:
          type: string
          enum: [low, medium, high]
        freshness:
          type: string
          description: Relative recency of the evidence item based on observed_at when provided
          enum: [low, medium, high]
        age_days:
          type: number
          format: float
          description: Approximate age of the evidence item in days, derived from observed_at and server time

    CEEEvidenceHelperRequestV1:
      type: object
      description: CEE evidence helper request payload
      required:
        - evidence
      properties:
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/CEEEvidenceItemRequestV1'

    CEEBiasCheckRequestV1:
      type: object
      description: CEE bias check request payload
      required:
        - graph
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        archetype:
          type: object
          description: Optional archetype metadata from a previous draft run
          properties:
            decision_type:
              type: string
            match:
              type: string
              enum: [exact, fuzzy, generic]
            confidence:
              type: number
              minimum: 0
              maximum: 1
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).
        seed:
          type: string
          description: Optional deterministic ordering seed for bias findings (not logged in telemetry).

    CEEOptionsRequestV1:
      type: object
      description: CEE options helper request
      required:
        - graph
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        archetype:
          type: object
          description: Optional archetype metadata from a previous draft run
          properties:
            decision_type:
              type: string
            match:
              type: string
              enum: [exact, fuzzy, generic]
            confidence:
              type: number
              minimum: 0
              maximum: 1
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEEDraftGraphResponseV1:
      allOf:
        - $ref: '#/components/schemas/DraftGraphOutput'
        - type: object
          required:
            - trace
            - quality
          properties:
            trace:
              $ref: '#/components/schemas/CEETraceMeta'
            quality:
              $ref: '#/components/schemas/CEEQualityMeta'
            validation_issues:
              type: array
              items:
                $ref: '#/components/schemas/CEEValidationIssue'
            archetype:
              type: object
              description: Archetype classification metadata
              properties:
                decision_type:
                  type: string
                  description: Classified decision type, e.g. pricing_decision
                match:
                  type: string
                  enum: [exact, fuzzy, generic]
                confidence:
                  type: number
                  minimum: 0
                  maximum: 1
            seed:
              type: string
              description: Seed value used for this response
            response_hash:
              type: string
              description: Engine-provided response hash for reproducibility
            response_limits:
              type: object
              properties:
                bias_findings_max:
                  type: integer
                bias_findings_truncated:
                  type: boolean
                options_max:
                  type: integer
                options_truncated:
                  type: boolean
                evidence_suggestions_max:
                  type: integer
                evidence_suggestions_truncated:
                  type: boolean
                sensitivity_suggestions_max:
                  type: integer
                sensitivity_suggestions_truncated:
                  type: boolean
            draft_warnings:
              type: array
              description: Optional structural warnings about the draft graph
              items:
                $ref: '#/components/schemas/CEEStructuralWarningV1'
            confidence_flags:
              $ref: '#/components/schemas/CEEConfidenceFlagsV1'
            guidance:
              $ref: '#/components/schemas/CEEGuidanceV1'
            clarifier:
              $ref: '#/components/schemas/CEEClarifierBlockV1'
            weight_suggestions:
              type: array
              description: Suggestions for edge weights that appear uniform/unrefined
              items:
                $ref: '#/components/schemas/CEEWeightSuggestionV1'
            comparison_suggested:
              type: boolean
              description: Whether the graph structure suggests comparison analysis would add value

    CEEWeightSuggestionV1:
      type: object
      description: A suggestion for refining an edge weight or belief
      required:
        - edge_id
        - from_node_id
        - to_node_id
        - current_belief
        - reason
      properties:
        edge_id:
          type: string
          description: Edge identifier in the format "from_id->to_node_id"
        from_node_id:
          type: string
          description: Source node identifier
        to_node_id:
          type: string
          description: Target node identifier
        current_belief:
          type: number
          minimum: 0
          maximum: 1
          description: Current edge belief value (0-1)
        current_weight:
          type: number
          description: Current edge weight value (for weight-related suggestions)
        reason:
          type: string
          enum: [uniform_distribution, near_zero, near_one, uniform_weights, weight_too_low, weight_too_high]
          description: Why this edge was flagged for refinement
        suggestion:
          type: string
          description: Human-readable suggestion for improvement
        suggested_belief:
          type: number
          minimum: 0
          maximum: 1
          description: LLM-recommended belief value (only included when confidence >= 0.7)
        suggested_weight:
          type: number
          minimum: 0.3
          maximum: 1.5
          description: Recommended weight value (for weight-related suggestions)
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence in the suggestion (0-1)
        rationale:
          type: string
          description: Explanation of why this value should be adjusted
        auto_applied:
          type: boolean
          description: >-
            Indicates whether this suggestion should be auto-applied by the client without user confirmation.
            True when confidence >= 0.7 (high/medium tier), false when confidence < 0.7 (low tier, requires manual review).
            This is a recommendation flag, not a status indicator - the server does NOT modify the graph.

    CEEClarifierBlockV1:
      type: object
      description: Multi-turn clarifier block for iterative graph refinement
      required:
        - needs_clarification
        - round
        - question_id
        - question
        - question_type
        - metadata
      properties:
        needs_clarification:
          type: boolean
          description: Whether clarification is needed before proceeding
        round:
          type: integer
          minimum: 1
          maximum: 10
          description: Current clarification round (1-indexed)
        question_id:
          type: string
          description: Unique identifier for tracking the answer
        question:
          type: string
          description: Natural language clarifying question
        question_type:
          type: string
          enum: [binary, multiple_choice, open_ended]
          description: Type of question for UI rendering
        options:
          type: array
          items:
            type: string
          description: Available options for multiple_choice questions
        metadata:
          $ref: '#/components/schemas/CEEClarifierMetadataV1'

    CEEClarifierMetadataV1:
      type: object
      description: Metadata about the clarifying question
      required:
        - targets_ambiguity
        - expected_improvement
        - convergence_confidence
        - information_gain
      properties:
        targets_ambiguity:
          type: string
          description: Which aspect of the decision this question resolves
        expected_improvement:
          type: number
          minimum: 0
          maximum: 10
          description: Estimated quality gain (0-10 scale)
        convergence_confidence:
          type: number
          minimum: 0
          maximum: 1
          description: How close to completion (0-1)
        information_gain:
          type: number
          minimum: 0
          maximum: 1
          description: Expected information gain for telemetry (0-1)
        convergence_status:
          type: string
          enum: [continue, complete, max_rounds, confident]
          description: Current convergence status (continue = still asking, others = would stop if no question)
        convergence_reason:
          type: string
          enum: [quality_threshold, stability, max_rounds, diminishing_returns, continue]
          description: Why clarification continues or would stop

    CEEExplainGraphResponseV1:
      type: object
      description: Structured explanation for a decision graph
      required:
        - trace
        - quality
        - explanation
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'
        explanation:
          type: object
          description: Structured explanation derived from inference results
          properties:
            targets:
              type: object
              additionalProperties:
                type: object
                properties:
                  summary:
                    type: string
                  p10:
                    type: number
                  p50:
                    type: number
                  p90:
                    type: number
            top_drivers:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  impact:
                    type: number
                  rank:
                    type: integer
                  label:
                    type: string

    CEEEvidenceHelperResponseV1:
      type: object
      description: CEE evidence helper response with strength scores
      required:
        - trace
        - quality
        - items
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        items:
          type: array
          items:
            $ref: '#/components/schemas/CEEEvidenceItemResponseV1'
        response_limits:
          type: object
          description: Response caps applied to evidence items, if any
          properties:
            items_max:
              type: integer
              description: Maximum number of items returned
              example: 20
            items_truncated:
              type: boolean
              description: Whether items was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEEStructuralWarningV1:
      type: object
      description: Structural issue detected in a draft decision graph
      required:
        - id
        - severity
      properties:
        id:
          type: string
          description: Stable identifier for this warning type
          enum: [no_outcome_node, orphan_node, cycle_detected, decision_after_outcome]
        severity:
          type: string
          enum: [low, medium, high]
        node_ids:
          type: array
          description: Related graph node IDs (no labels or free text)
          items:
            type: string
        edge_ids:
          type: array
          description: Related graph edge IDs (no labels or free text)
          items:
            type: string
        explanation:
          type: string
          description: Short human-readable explanation (not used in telemetry)

    CEEConfidenceFlagsV1:
      type: object
      description: Machine-friendly confidence flags for a draft graph
      properties:
        uncertain_nodes:
          type: array
          description: Graph node IDs with lower structural or coverage confidence
          items:
            type: string
        simplification_applied:
          type: boolean
          description: True if structural simplification or response caps were applied

    CEEBiasFindingV1:
      type: object
      description: Bias or fairness-related finding detected by CEE
      required:
        - id
        - category
        - severity
      properties:
        id:
          type: string
          description: Stable identifier for this finding type
        category:
          type: string
          enum: [selection, measurement, optimisation, framing, other]
        severity:
          type: string
          enum: [low, medium, high]
        node_ids:
          type: array
          description: Related graph node IDs (no labels or free text)
          items:
            type: string
        explanation:
          type: string
          description: Short human-readable explanation (not used in telemetry)
        code:
          type: string
          description: Optional canonical code for this bias (usually matches id)
        targets:
          type: object
          description: Targeted graph elements for this finding
          properties:
            node_ids:
              type: array
              items:
                type: string
            edge_ids:
              type: array
              items:
                type: string
        structural_pattern:
          type: string
          description: Short description of the structural pattern that triggered this bias
        confidence_band:
          type: string
          description: Discrete confidence band for this finding
          enum: [low, medium, high]
        micro_intervention:
          type: object
          description: Small recommended actions to address this bias
          properties:
            steps:
              type: array
              items:
                type: string
            estimated_minutes:
              type: integer
              description: Estimated minutes required to apply this intervention (1-5)
        mechanism:
          type: string
          description: Plain-language description of the bias mechanism
        citation:
          type: string
          description: Short citation to the underlying research source
        causal_validation:
          $ref: '#/components/schemas/CausalValidationV1'
        evidence_strength:
          type: array
          description: Evidence strength analysis from causal inference
          items:
            $ref: '#/components/schemas/EvidenceStrengthV1'

    CausalValidationV1:
      type: object
      description: Causal validation result from ISL (Inference & Structure Learning)
      required:
        - identifiable
        - strength
        - confidence
      properties:
        identifiable:
          type: boolean
          description: Whether the bias effect is causally identifiable in the graph
        strength:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Strength of causal impact (0-1 scale)
        confidence:
          type: string
          enum: [low, medium, high]
          description: Confidence level in the validation
        details:
          type: object
          description: Detailed causal analysis
          properties:
            affected_paths:
              type: array
              description: Causal paths identified in the graph
              items:
                type: string
            counterfactual_delta:
              type: object
              description: Counterfactual impact measurement
              properties:
                metric:
                  type: string
                  description: Metric being measured (e.g., "outcome_range")
                change_percent:
                  type: number
                  description: Percentage change (e.g., 30 = "widens by 30%")

    EvidenceStrengthV1:
      type: object
      description: Evidence strength classification for a graph node
      required:
        - node_id
        - causal_support
      properties:
        node_id:
          type: string
          description: Node ID being analyzed
        causal_support:
          type: string
          enum: [none, weak, moderate, strong]
          description: Level of causal support this evidence provides
        reasoning:
          type: string
          description: Optional reasoning for the classification

    CEEBiasCheckResponseV1:
      type: object
      description: Structured bias findings for a decision graph
      required:
        - trace
        - quality
        - bias_findings
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        bias_findings:
          type: array
          items:
            $ref: '#/components/schemas/CEEBiasFindingV1'
        response_limits:
          type: object
          description: Response caps applied to bias findings, if any
          properties:
            bias_findings_max:
              type: integer
              description: Maximum number of bias findings returned
              example: 10
            bias_findings_truncated:
              type: boolean
              description: Whether bias_findings was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'
        mitigation_patches:
          type: array
          items:
            $ref: '#/components/schemas/CEEBiasMitigationPatchV1'

    CEEBiasMitigationPatchV1:
      type: object
      description: Graph-structural mitigation suggestion for a specific bias finding
      required:
        - bias_code
        - patch
      properties:
        bias_code:
          type: string
          description: Canonical bias code this mitigation is associated with
        bias_id:
          type: string
          description: Optional identifier for the concrete bias finding instance
        description:
          type: string
          description: Short description of the suggested structural change
        patch:
          $ref: '#/components/schemas/GraphPatch'

    CEEGraphReadinessRequestV1:
      type: object
      description: CEE graph readiness assessment request payload
      required:
        - graph
      properties:
        graph:
          $ref: '#/components/schemas/Graph'

    CEEGraphReadinessResponseV1:
      type: object
      description: Pre-analysis graph readiness assessment
      required:
        - readiness_score
        - readiness_level
        - confidence_level
        - confidence_explanation
        - quality_factors
        - can_run_analysis
        - trace
      properties:
        readiness_score:
          type: integer
          minimum: 0
          maximum: 100
          description: Overall readiness score (0-100)
          example: 61
        readiness_level:
          type: string
          enum: [ready, fair, needs_work]
          description: Categorical readiness assessment
          example: fair
        confidence_level:
          type: string
          enum: [high, medium, low]
          description: Confidence in the assessment accuracy
          example: medium
        confidence_explanation:
          type: string
          description: Plain language explanation for the confidence level
          example: Your model has sufficient detail for directional insights but needs more causal factors for precise predictions
        quality_factors:
          type: array
          description: Breakdown of quality factors with recommendations
          items:
            $ref: '#/components/schemas/CEEQualityFactorV1'
        can_run_analysis:
          type: boolean
          description: Whether the graph meets minimum requirements for analysis
          example: true
        blocker_reason:
          type: string
          description: Reason analysis is blocked (if can_run_analysis is false)
        trace:
          $ref: '#/components/schemas/CEETraceMeta'

    CEEQualityFactorV1:
      type: object
      description: Quality factor with score and improvement recommendation
      required:
        - factor
        - current_score
        - impact
        - recommendation
        - potential_improvement
      properties:
        factor:
          type: string
          enum: [causal_detail, weight_refinement, risk_coverage, outcome_balance, option_diversity]
          description: Quality factor identifier
          example: causal_detail
        current_score:
          type: integer
          minimum: 0
          maximum: 100
          description: Current score for this factor
          example: 55
        impact:
          type: string
          enum: [high, medium, low]
          description: Impact of this factor on overall quality
          example: high
        recommendation:
          type: string
          description: Actionable suggestion to improve this factor
          example: Add 2-3 causal Factor nodes between Options and Outcomes
        potential_improvement:
          type: integer
          minimum: 0
          maximum: 100
          description: Estimated score gain if recommendation is followed
          example: 12

    RankedActionV1:
      type: object
      description: A ranked action from PLoT inference
      required:
        - node_id
        - label
        - expected_utility
      properties:
        node_id:
          type: string
          description: Node ID of the option
          example: opt-1
        label:
          type: string
          description: Label of the option (may contain question marks - will be sanitised)
          example: Implement time-tracking software?
        expected_utility:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Expected utility score (higher is better)
          example: 0.78
        dominant:
          type: boolean
          description: Whether this option is clearly dominant over alternatives
          example: false

    DriverV1:
      type: object
      description: A driver from PLoT inference
      required:
        - node_id
        - label
      properties:
        node_id:
          type: string
          description: Node ID of the driver node
          example: drv-1
        label:
          type: string
          description: Label of the driver
          example: Revenue impact
        impact_pct:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Impact percentage (0-100)
          example: 45
        direction:
          type: string
          enum: [positive, negative, neutral]
          description: Direction of influence
          example: positive

    CEEKeyInsightRequestV1:
      type: object
      description: CEE key insight request payload
      required:
        - graph
        - ranked_actions
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        ranked_actions:
          type: array
          description: Ranked actions from PLoT inference (required, min 1)
          minItems: 1
          items:
            $ref: '#/components/schemas/RankedActionV1'
        top_drivers:
          type: array
          description: Top drivers from PLoT inference (optional)
          items:
            $ref: '#/components/schemas/DriverV1'
        context_id:
          type: string
          description: Optional context identifier for tracing

    CEEKeyInsightResponseV1:
      type: object
      description: Generated key insight with clean prose
      required:
        - headline
        - primary_driver
        - confidence_statement
        - quality
        - trace
        - provenance
      properties:
        headline:
          type: string
          description: Main recommendation headline (sanitised, no question marks)
          example: Implementing time-tracking software is the stronger option
        primary_driver:
          type: string
          description: Primary driver explanation
          example: Revenue impact is the dominant factor, accounting for 45% of the outcome.
        confidence_statement:
          type: string
          description: Confidence statement about the recommendation
          example: This recommendation has high confidence based on the analysis.
        caveat:
          type: string
          description: Optional caveat if the recommendation is close
          example: Consider that manual tracking is a close second—sensitivity analysis recommended.
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        provenance:
          type: string
          enum: [cee]
          description: Always 'cee' to indicate CEE generated this response
          example: cee

    CEEElicitBeliefRequestV1:
      type: object
      description: CEE elicit belief request payload
      required:
        - node_id
        - node_label
        - user_expression
        - target_type
      properties:
        node_id:
          type: string
          description: ID of the node this belief applies to
          example: n1
        node_label:
          type: string
          description: Human-readable label for the node
          example: Market expansion succeeds
        user_expression:
          type: string
          description: Natural language probability expression from the user
          example: pretty likely
        target_type:
          type: string
          enum: [prior, edge_weight]
          description: Whether this is a prior belief or edge weight
          example: prior
        context_id:
          type: string
          description: Optional context identifier for tracing

    CEEElicitBeliefOptionV1:
      type: object
      description: Clickable option for clarification
      required:
        - label
        - value
      properties:
        label:
          type: string
          description: Human-readable label for the option
          example: Very likely (85%)
        value:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Normalized probability value
          example: 0.85

    CEEElicitBeliefResponseV1:
      type: object
      description: Elicited belief result with optional clarification
      required:
        - suggested_value
        - confidence
        - reasoning
        - needs_clarification
        - provenance
      properties:
        suggested_value:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Normalized probability value (0-1)
          example: 0.70
        confidence:
          type: string
          enum: [high, medium, low]
          description: Confidence in the interpretation
          example: high
        reasoning:
          type: string
          description: Explanation of how the value was derived
          example: Interpreted "pretty likely" as approximately 70% probability based on common usage.
        needs_clarification:
          type: boolean
          description: Whether the expression was ambiguous and needs clarification
          example: false
        clarifying_question:
          type: string
          description: Question to ask the user if clarification is needed
          example: What probability would you assign to "Market expansion succeeds"?
        options:
          type: array
          description: Clickable options for clarification
          items:
            $ref: '#/components/schemas/CEEElicitBeliefOptionV1'
        provenance:
          type: string
          enum: [cee]
          description: Always 'cee' to indicate CEE generated this response
          example: cee
        trace:
          $ref: '#/components/schemas/CEETraceMeta'

    CEEUtilityWeightRequestV1:
      type: object
      description: CEE utility weight suggestions request payload
      required:
        - graph
        - outcome_node_ids
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        outcome_node_ids:
          type: array
          description: IDs of outcome nodes to suggest weights for
          items:
            type: string
          example: ["o1", "o2", "o3"]
        decision_description:
          type: string
          description: Optional context about the decision being made
          example: Choosing a market expansion strategy
        context_id:
          type: string
          description: Optional context identifier for tracing

    CEEWeightSuggestionItemV1:
      type: object
      description: Individual weight suggestion for an outcome node
      required:
        - node_id
        - node_label
        - suggested_weight
        - reasoning
      properties:
        node_id:
          type: string
          description: ID of the outcome node
          example: o1
        node_label:
          type: string
          description: Human-readable label of the node
          example: Revenue growth
        suggested_weight:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Suggested importance weight (0-1)
          example: 0.45
        reasoning:
          type: string
          description: Explanation for the suggested weight
          example: Weight based on high-priority indicator.

    CEEAlternativeWeightingV1:
      type: object
      description: Alternative weighting scheme
      required:
        - name
        - description
        - weights
      properties:
        name:
          type: string
          description: Name of the alternative weighting scheme
          example: Risk-averse
        description:
          type: string
          description: Explanation of this weighting approach
          example: Emphasizes risk mitigation over benefit maximization.
        weights:
          type: array
          description: Weights for each outcome node
          items:
            type: object
            required:
              - node_id
              - weight
            properties:
              node_id:
                type: string
                description: ID of the outcome node
              weight:
                type: number
                format: double
                minimum: 0
                maximum: 1
                description: Weight for this node

    CEEUtilityWeightResponseV1:
      type: object
      description: Utility weight suggestions with alternatives
      required:
        - suggestions
        - reasoning
        - confidence
        - provenance
      properties:
        suggestions:
          type: array
          description: Weight suggestions for each outcome node
          items:
            $ref: '#/components/schemas/CEEWeightSuggestionItemV1'
        reasoning:
          type: string
          description: Overall reasoning for the weight distribution
          example: Based on semantic analysis of outcome labels, "Revenue growth" appears most significant.
        confidence:
          type: string
          enum: [high, medium, low]
          description: Confidence in the weight suggestions
          example: high
        alternatives:
          type: array
          description: Alternative weighting schemes (risk-averse, growth-focused, balanced)
          items:
            $ref: '#/components/schemas/CEEAlternativeWeightingV1'
        provenance:
          type: string
          enum: [cee]
          description: Always 'cee' to indicate CEE generated this response
          example: cee
        trace:
          $ref: '#/components/schemas/CEETraceMeta'

    CEERiskToleranceRequestV1:
      type: object
      description: CEE risk tolerance elicitation request payload
      required:
        - mode
      properties:
        mode:
          type: string
          enum: [get_questions, process_responses]
          description: Operation mode - get questions or process user responses
          example: get_questions
        context:
          type: string
          enum: [product, business]
          default: product
          description: Context for questions (product decisions vs business strategy)
          example: product
        responses:
          type: array
          description: User responses to questions (required for process_responses mode)
          items:
            type: object
            required:
              - question_id
              - option_id
            properties:
              question_id:
                type: string
                description: ID of the question answered
              option_id:
                type: string
                description: ID of the selected option
        context_id:
          type: string
          description: Optional context identifier for tracing

    CEERiskToleranceOptionV1:
      type: object
      description: Option for a risk tolerance question
      required:
        - id
        - label
        - risk_score
      properties:
        id:
          type: string
          description: Unique identifier for this option
          example: q1_o1
        label:
          type: string
          description: Short label for the option
          example: Wait for polish
        description:
          type: string
          description: Detailed description of the option
          example: Delay launch by 2 weeks to refine UX and fix edge cases
        risk_score:
          type: integer
          minimum: 0
          maximum: 100
          description: Risk score (0 = risk averse, 100 = risk seeking)
          example: 20

    CEERiskToleranceQuestionV1:
      type: object
      description: Risk tolerance assessment question
      required:
        - id
        - question
        - options
      properties:
        id:
          type: string
          description: Unique identifier for this question
          example: q1_feature_launch
        question:
          type: string
          description: The question text
          example: "You're deciding when to launch a new feature. What's your preference?"
        options:
          type: array
          description: Available response options
          items:
            $ref: '#/components/schemas/CEERiskToleranceOptionV1'

    CEERiskToleranceGetQuestionsResponseV1:
      type: object
      description: Response containing risk tolerance questions
      required:
        - questions
        - provenance
      properties:
        questions:
          type: array
          description: Questions for risk tolerance assessment
          items:
            $ref: '#/components/schemas/CEERiskToleranceQuestionV1'
        provenance:
          type: string
          enum: [cee]
          description: Always 'cee' to indicate CEE generated this response
          example: cee
        trace:
          $ref: '#/components/schemas/CEETraceMeta'

    CEERiskProfileV1:
      type: object
      description: User's risk tolerance profile
      required:
        - type
        - score
        - reasoning
        - recommended_coefficient
      properties:
        type:
          type: string
          enum: [risk_averse, risk_neutral, risk_seeking]
          description: Risk profile category
          example: risk_neutral
        score:
          type: integer
          minimum: 0
          maximum: 100
          description: Overall risk tolerance score
          example: 50
        reasoning:
          type: string
          description: Explanation of the risk profile assessment
          example: Your responses indicate a balanced approach to risk.
        recommended_coefficient:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Recommended utility coefficient for decision analysis
          example: 0.5

    CEERiskBreakdownV1:
      type: object
      description: Risk tolerance breakdown by category
      required:
        - certainty
        - loss_aversion
        - time_preference
      properties:
        certainty:
          type: integer
          minimum: 0
          maximum: 100
          description: Preference for certain vs uncertain outcomes
          example: 50
        loss_aversion:
          type: integer
          minimum: 0
          maximum: 100
          description: Sensitivity to potential losses vs gains
          example: 45
        time_preference:
          type: integer
          minimum: 0
          maximum: 100
          description: Preference for near-term vs long-term outcomes
          example: 55

    CEERiskToleranceProcessResponsesResponseV1:
      type: object
      description: Response containing processed risk tolerance profile
      required:
        - profile
        - breakdown
        - confidence
        - provenance
      properties:
        profile:
          $ref: '#/components/schemas/CEERiskProfileV1'
        breakdown:
          $ref: '#/components/schemas/CEERiskBreakdownV1'
        confidence:
          type: string
          enum: [high, medium, low]
          description: Confidence in the assessment based on response coverage
          example: high
        provenance:
          type: string
          enum: [cee]
          description: Always 'cee' to indicate CEE generated this response
          example: cee
        trace:
          $ref: '#/components/schemas/CEETraceMeta'

    CEENodeInfoV1:
      type: object
      description: Node information for edge function suggestion
      required:
        - id
        - label
        - kind
      properties:
        id:
          type: string
          description: Node identifier
          example: n1
        label:
          type: string
          description: Human-readable node label
          example: Marketing spend
        kind:
          type: string
          description: Node kind (goal, decision, option, outcome, risk)
          example: option

    CEEEdgeFunctionSuggestionRequestV1:
      type: object
      description: CEE edge function suggestion request payload
      required:
        - edge_id
        - source_node
        - target_node
      properties:
        edge_id:
          type: string
          description: Edge identifier
          example: e1
        source_node:
          $ref: '#/components/schemas/CEENodeInfoV1'
        target_node:
          $ref: '#/components/schemas/CEENodeInfoV1'
        relationship_description:
          type: string
          description: Optional natural language description of the relationship
          example: "Spending more on marketing leads to diminishing returns over time"
        context_id:
          type: string
          description: Optional context identifier for tracing

    CEEEdgeFunctionParamsV1:
      type: object
      description: Parameters for the suggested edge function
      properties:
        k:
          type: number
          description: Steepness parameter (for diminishing_returns and s_curve)
          example: 2.0
        threshold:
          type: number
          description: Threshold value (for threshold function)
          example: 0.5
        slope:
          type: number
          description: Slope at threshold (for threshold function)
          example: 1.0
        midpoint:
          type: number
          description: Midpoint for S-curve
          example: 0.5

    CEEEdgeFunctionAlternativeV1:
      type: object
      description: Alternative edge function suggestion
      required:
        - function_type
        - params
        - reasoning
      properties:
        function_type:
          type: string
          enum: [linear, diminishing_returns, threshold, s_curve]
          description: Alternative function type
          example: threshold
        params:
          $ref: '#/components/schemas/CEEEdgeFunctionParamsV1'
        reasoning:
          type: string
          description: Why this alternative might be appropriate
          example: "The relationship may have a threshold effect"

    CEEEdgeFunctionSuggestionResponseV1:
      type: object
      description: CEE edge function suggestion response
      required:
        - suggested_function
        - suggested_params
        - reasoning
        - alternatives
        - confidence
        - provenance
      properties:
        suggested_function:
          type: string
          enum: [linear, diminishing_returns, threshold, s_curve]
          description: Recommended edge function type
          example: diminishing_returns
        suggested_params:
          $ref: '#/components/schemas/CEEEdgeFunctionParamsV1'
        reasoning:
          type: string
          description: Why this function type was suggested
          example: "Relationship shows diminishing returns pattern - initial inputs have strong effects that taper off"
        alternatives:
          type: array
          description: Alternative function types to consider
          items:
            $ref: '#/components/schemas/CEEEdgeFunctionAlternativeV1'
        confidence:
          type: string
          enum: [high, medium, low]
          description: Confidence in the suggestion based on pattern matching
          example: high
        provenance:
          type: string
          enum: [cee]
          description: Always 'cee' to indicate CEE generated this response
          example: cee
        trace:
          $ref: '#/components/schemas/CEETraceMeta'

    CEEOptionV1:
      type: object
      description: Structured decision option suggested by CEE
      required:
        - id
        - kind
      properties:
        id:
          type: string
          description: Stable identifier for this option suggestion
        kind:
          type: string
          enum: [expand_scope, reduce_scope, change_channel, adjust_timing, other]
        node_ids:
          type: array
          description: Related graph node IDs (no labels or free text)
          items:
            type: string
        priority:
          type: string
          description: Relative importance or urgency of this option
          enum: [low, medium, high]
        explanation:
          type: string
          description: Short human-readable explanation (not used in telemetry)

    CEEOptionsResponseV1:
      type: object
      description: Structured options suggestions for a decision graph
      required:
        - trace
        - quality
        - options
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        options:
          type: array
          items:
            $ref: '#/components/schemas/CEEOptionV1'
        response_limits:
          type: object
          description: Response caps applied to options list, if any
          properties:
            options_max:
              type: integer
              description: Maximum number of options returned
            options_truncated:
              type: boolean
              description: Whether options list was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEESensitivityCoachRequestV1:
      type: object
      description: CEE sensitivity coach request payload
      required:
        - graph
        - inference
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        inference:
          type: object
          required:
            - summary
            - seed
            - response_hash
          properties:
            summary:
              type: string
              description: Short summary of the inference run.
            explain:
              type: object
              description: Optional explainability metadata used to derive suggestions.
              properties:
                top_drivers:
                  type: array
                  items:
                    type: object
                    required:
                      - node_id
                    properties:
                      node_id:
                        type: string
                      description:
                        type: string
                      contribution:
                        type: number
                  default: []
            model_card:
              type: object
              additionalProperties: true
              description: Optional model metadata blob.
            seed:
              type: string
            response_hash:
              type: string
        context_id:
          type: string
          description: Optional opaque context identifier (not logged in telemetry).

    CEESensitivitySuggestionV1:
      type: object
      description: Deterministic sensitivity suggestion derived from inference top drivers.
      required:
        - driver_id
        - rank
      properties:
        driver_id:
          type: string
          description: ID of the driver node in the graph.
        rank:
          type: integer
          minimum: 1
          description: Ordering of this suggestion (1 is the strongest driver).
        direction:
          type: string
          enum: [increase, decrease]
          description: Suggested direction to probe (increase/decrease). Absent when contribution is 0.
        target_id:
          type: string
          description: Optional target node for further analysis (reserved for future versions).

    CEESensitivityCoachResponseV1:
      type: object
      description: Structured sensitivity coaching for a decision graph
      required:
        - trace
        - quality
        - sensitivity_suggestions
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        sensitivity_suggestions:
          type: array
          items:
            $ref: '#/components/schemas/CEESensitivitySuggestionV1'
        response_limits:
          type: object
          description: Response caps applied to sensitivity suggestions, if any
          properties:
            sensitivity_suggestions_max:
              type: integer
              description: Maximum number of suggestions returned
            sensitivity_suggestions_truncated:
              type: boolean
              description: Whether sensitivity_suggestions was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEETeamPerspectiveItemV1:
      type: object
      description: Individual team perspective item
      required:
        - id
        - stance
      properties:
        id:
          type: string
          description: Opaque participant identifier
        stance:
          type: string
          enum: [for, against, neutral]
        weight:
          type: number
          description: Optional positive weight for this participant (0 or negative values are treated as 0).
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Optional confidence in this stance.

    CEETeamPerspectivesRequestV1:
      type: object
      description: CEE team perspectives request payload
      required:
        - perspectives
      properties:
        perspectives:
          type: array
          items:
            $ref: '#/components/schemas/CEETeamPerspectiveItemV1'
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEETeamPerspectivesSummaryV1:
      type: object
      description: Aggregated summary of team perspectives.
      required:
        - participant_count
        - for_count
        - against_count
        - neutral_count
        - disagreement_score
      properties:
        participant_count:
          type: integer
          description: Total number of participants.
        for_count:
          type: integer
          description: Number of participants with stance "for".
        against_count:
          type: integer
          description: Number of participants with stance "against".
        neutral_count:
          type: integer
          description: Number of participants with stance "neutral".
        weighted_for_fraction:
          type: number
          minimum: 0
          maximum: 1
          description: Weighted fraction of "for" stances; neutrals are included in the denominator.
        disagreement_score:
          type: number
          minimum: 0
          maximum: 1
          description: 0 means everyone is aligned on the same stance; higher values indicate more disagreement.
        has_team_disagreement:
          type: boolean
          description: |
            True when disagreement_score is above an internal threshold and there are enough
            participants to consider the disagreement material. Exposed as a convenience flag
            for UIs; always derived from existing summary metadata.

    CeeServiceHealthSummaryV1:
      type: object
      description: Aggregated CEE service health summary derived from /healthz and diagnostics.
      required:
        - diagnostics_enabled
        - feature_flags
        - cee_config
      properties:
        service:
          type: string
          description: Logical service name (usually "assistants").
        version:
          type: string
          description: Service version string from the running deployment.
        provider:
          type: string
          description: Active LLM provider used by the service.
        model:
          type: string
          description: Active LLM model identifier.
        limits_source:
          type: string
          description: Where graph limits are sourced from (engine vs config).
        diagnostics_enabled:
          type: boolean
          description: Whether CEE diagnostics are enabled on this deployment.
        feature_flags:
          type: object
          additionalProperties:
            type: boolean
          description: Snapshot of all feature flags exposed by the service.
        cee_config:
          type: object
          description: Per-capability CEE configuration (feature versions and RPM limits).
          additionalProperties:
            type: object
            properties:
              feature_version:
                type: string
              rate_limit_rpm:
                type: integer
        recent_error_counts:
          type: object
          properties:
            total:
              type: integer
            by_capability:
              type: object
              additionalProperties:
                type: integer
            by_status:
              type: object
              additionalProperties:
                type: integer
            by_error_code:
              type: object
              additionalProperties:
                type: integer

    CEETeamPerspectivesResponseV1:
      type: object
      description: CEE team perspectives response
      required:
        - trace
        - quality
        - summary
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        summary:
          $ref: '#/components/schemas/CEETeamPerspectivesSummaryV1'
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    DecisionStorySummaryV1:
      type: object
      description: High-level decision story summary derived from CEE envelopes.
      required:
        - headline
        - key_drivers
        - risks_and_gaps
        - next_actions
        - any_truncated
      properties:
        headline:
          type: string
          description: Short narrative summary of the decision and CEE judgement.
        key_drivers:
          type: array
          description: Concise, content-free drivers behind the decision posture.
          items:
            type: string
        risks_and_gaps:
          type: array
          description: High-level risks or gaps surfaced by CEE (no user text).
          items:
            type: string
        next_actions:
          type: array
          description: Suggested next actions to improve confidence in the decision.
          items:
            type: string
        any_truncated:
          type: boolean
          description: True when any underlying CEE envelope applied deterministic caps.
        quality_overall:
          type: integer
          minimum: 1
          maximum: 10
          description: Overall quality score (1–10) mirrored from CEEQualityMeta.overall.

    CeeHealthSummaryV1:
      type: object
      description: Per-envelope health summary derived from CEE metadata.
      required:
        - status
        - reasons
        - any_truncated
        - has_validation_issues
        - source
      properties:
        status:
          type: string
          enum: [ok, warning, risk]
        reasons:
          type: array
          items:
            type: string
        any_truncated:
          type: boolean
        has_validation_issues:
          type: boolean
        quality_overall:
          type: integer
          minimum: 1
          maximum: 10
        source:
          type: string
          enum: [draft, explain, evidence, bias, options, sensitivity, team]

    CeeJourneyHealthV1:
      type: object
      description: Aggregated journey-level health across CEE envelopes.
      required:
        - perEnvelope
        - overallStatus
        - overallTone
        - any_truncated
        - has_validation_issues
      properties:
        perEnvelope:
          type: object
          properties:
            draft:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            explain:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            evidence:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            bias:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            options:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            sensitivity:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            team:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
        overallStatus:
          type: string
          enum: [ok, warning, risk]
        overallTone:
          type: string
          enum: [success, warning, danger]
        any_truncated:
          type: boolean
        has_validation_issues:
          type: boolean

    CeeJourneySummaryV1:
      type: object
      description: Combined decision story and health summary for a CEE journey.
      required:
        - story
        - health
        - is_complete
        - missing_envelopes
        - has_team_disagreement
      properties:
        story:
          $ref: '#/components/schemas/DecisionStorySummaryV1'
        health:
          $ref: '#/components/schemas/CeeJourneyHealthV1'
        is_complete:
          type: boolean
        missing_envelopes:
          type: array
          items:
            type: string
            enum: [draft, explain, evidence, bias, options, sensitivity, team]
        has_team_disagreement:
          type: boolean

    CeeUiFlagsV1:
      type: object
      description: High-level UI flags derived from the journey summary.
      required:
        - has_high_risk_envelopes
        - has_team_disagreement
        - has_truncation_somewhere
        - is_journey_complete
      properties:
        has_high_risk_envelopes:
          type: boolean
        has_team_disagreement:
          type: boolean
        has_truncation_somewhere:
          type: boolean
        is_journey_complete:
          type: boolean

    CeeDecisionReviewBundle:
      type: object
      description: |
        UI-friendly bundle summarising CEE envelopes as story/journey/uiFlags.
        This is a derived view for frontend consumption, not the wire contract.
      required:
        - story
        - journey
        - uiFlags
      properties:
        story:
          $ref: '#/components/schemas/DecisionStorySummaryV1'
        journey:
          $ref: '#/components/schemas/CeeJourneySummaryV1'
        uiFlags:
          $ref: '#/components/schemas/CeeUiFlagsV1'
        trace:
          type: object
          description: Optional trace identifiers (request/correlation IDs only).
          properties:
            request_id:
              type: string
            correlation_id:
              type: string

    CeeDecisionReviewPayloadV1:
      type: object
      description: |
        Frozen v1 contract for CEE decision review. Additive-only evolution.
        See schemas/cee-decision-review.v1.json for the authoritative JSON Schema.
      required:
        - schema
        - version
        - decision_id
        - review
      properties:
        schema:
          type: string
          enum: [cee.decision-review.v1]
        version:
          type: string
          enum: ['1.0.0']
        decision_id:
          type: string
          minLength: 1
        scenario_id:
          type: string
          nullable: true
        review:
          $ref: '#/components/schemas/CeeReviewV1'
        trace:
          $ref: '#/components/schemas/CeeReviewTraceV1'
        meta:
          $ref: '#/components/schemas/CeeReviewMetaV1'

    CeeReviewV1:
      type: object
      description: The review section of a CEE Decision Review payload.
      required:
        - summary
        - confidence
        - recommendations
      properties:
        summary:
          type: string
          description: Plain-English summary of decision quality.
        confidence:
          type: number
          minimum: 0
          maximum: 1
        quality_band:
          type: string
          enum: [high, medium, low]
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/CeeRecommendationV1'
        bias_findings:
          type: array
          items:
            $ref: '#/components/schemas/CeeBiasFindingV1'
        structural_issues:
          type: array
          items:
            $ref: '#/components/schemas/CeeStructuralIssueV1'
        strengths:
          type: array
          items:
            type: string

    CeeRecommendationV1:
      type: object
      required:
        - id
        - priority
        - message
      properties:
        id:
          type: string
        priority:
          type: string
          enum: [high, medium, low]
        message:
          type: string
        action:
          type: string
        affected_nodes:
          type: array
          items:
            type: string

    CeeBiasFindingV1:
      type: object
      required:
        - code
        - severity
        - message
      properties:
        code:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low]
        message:
          type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
        affected_node_ids:
          type: array
          items:
            type: string
        micro_intervention:
          type: object
          properties:
            steps:
              type: array
              items:
                type: string
            estimated_minutes:
              type: integer

    CeeStructuralIssueV1:
      type: object
      required:
        - code
        - severity
        - message
      properties:
        code:
          type: string
        severity:
          type: string
          enum: [error, warning, info]
        message:
          type: string
        affected_node_ids:
          type: array
          items:
            type: string

    CeeReviewTraceV1:
      type: object
      properties:
        request_id:
          type: string
        correlation_id:
          type: string
        latency_ms:
          type: integer
        model_version:
          type: string

    CeeReviewMetaV1:
      type: object
      properties:
        created_at:
          type: string
          format: date-time
        graph_hash:
          type: string
        seed:
          type: integer

    SSEStream:
      type: object
      description: Server-Sent Events stream format
      properties:
        event:
          type: string
          enum: [stage]
          description: Event type (always "stage" for graph drafting)
        data:
          oneOf:
            - $ref: '#/components/schemas/SSEDraftingEvent'
            - $ref: '#/components/schemas/SSECompleteEvent'

    SSEDraftingEvent:
      type: object
      required:
        - stage
      properties:
        stage:
          type: string
          enum: [DRAFTING]
        payload:
          $ref: '#/components/schemas/DraftGraphOutput'
          description: Optional fixture graph (shown after 2.5s timeout)

    SSECompleteEvent:
      type: object
      required:
        - stage
        - payload
      properties:
        stage:
          type: string
          enum: [COMPLETE]
        payload:
          oneOf:
            - $ref: '#/components/schemas/DraftGraphOutput'
            - $ref: '#/components/schemas/ErrorV1'

    SSEErrorStream:
      type: object
      properties:
        event:
          type: string
          enum: [stage]
        data:
          type: object
          properties:
            stage:
              type: string
              enum: [COMPLETE]
            payload:
              $ref: '#/components/schemas/ErrorV1'

  requestBodies:
    DraftGraphRequest:
      description: Graph drafting request
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DraftGraphInput'

  responses:
    BadInput:
      description: Invalid input data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "BAD_INPUT"
            message: "invalid input"
            details:
              fieldErrors:
                brief: ["String must contain at least 30 character(s)"]

    PayloadTooLarge:
      description: Request payload exceeds 1 MB limit
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "BAD_INPUT"
            message: "Request payload too large"
            details:
              limit_bytes: 1048576

    RateLimited:
      description: |
        Rate limit exceeded. Default limits:
        - Global: 120 requests/minute per IP (configurable via GLOBAL_RATE_LIMIT_RPM)
        - Per-key: 120 requests/minute (configurable via RATE_LIMIT_RPM)
        - SSE endpoints: 20 requests/minute (configurable via SSE_RATE_LIMIT_RPM)
      headers:
        X-RateLimit-Limit:
          description: Request limit per window
          schema:
            type: integer
            example: 120
        X-RateLimit-Remaining:
          description: Requests remaining in current window
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          description: Time when rate limit resets (Unix timestamp)
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "RATE_LIMITED"
            message: "Rate limit exceeded"
            details:
              max: 120
              window_ms: 60000

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "INTERNAL"
            message: "internal server error"

    CeeDecisionReviewBundleExample:
      description: |
        Example CEE Decision Review Bundle (story/journey/uiFlags). Intended for
        engine/PLoT documentation and SDK alignment; not exposed as a runtime
        HTTP response. This is a UI-friendly summary, not the wire contract.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CeeDecisionReviewBundle'
          example:
            story:
              headline: "CEE currently rates overall model quality at 7/10 (high). The model includes 2 explicit decision options. Team input from 3 participants has been summarised. Some response lists were capped; review risks and next actions before treating this as final."
              key_drivers:
                - "2 CEE options were generated for this decision."
                - "3 evidence items were scored for strength and relevance."
                - "3 team perspectives contributed to this view."
              risks_and_gaps:
                - "CEE reported validation issues for this result; check them before treating it as final."
                - "Some lists were truncated for performance; lower-priority items may be missing."
              next_actions:
                - "Review the validation issues surfaced by CEE and address structural problems before committing."
                - "If this is a high-impact decision, consider narrowing the scope and re-running CEE to reduce truncation."
              any_truncated: true
              quality_overall: 7
            journey:
              story:
                headline: "CEE currently rates overall model quality at 7/10 (high). The model includes 2 explicit decision options. Team input from 3 participants has been summarised. Some response lists were capped; review risks and next actions before treating this as final."
                key_drivers:
                  - "2 CEE options were generated for this decision."
                  - "3 evidence items were scored for strength and relevance."
                  - "3 team perspectives contributed to this view."
                risks_and_gaps:
                  - "CEE reported validation issues for this result; check them before treating it as final."
                  - "Some lists were truncated for performance; lower-priority items may be missing."
                next_actions:
                  - "Review the validation issues surfaced by CEE and address structural problems before committing."
                  - "If this is a high-impact decision, consider narrowing the scope and re-running CEE to reduce truncation."
                any_truncated: true
                quality_overall: 7
              health:
                perEnvelope:
                  draft:
                    status: "ok"
                    reasons: []
                    any_truncated: false
                    has_validation_issues: false
                    quality_overall: 7
                    source: "draft"
                  options:
                    status: "warning"
                    reasons:
                      - "Some results were truncated for performance; lower-priority items may be missing."
                    any_truncated: true
                    has_validation_issues: true
                    quality_overall: 6
                    source: "options"
                  evidence:
                    status: "ok"
                    reasons: []
                    any_truncated: false
                    has_validation_issues: false
                    quality_overall: 7
                    source: "evidence"
                  bias:
                    status: "risk"
                    reasons:
                      - "CEE reported validation issues for this result; check them before treating it as final."
                    any_truncated: false
                    has_validation_issues: true
                    quality_overall: 5
                    source: "bias"
                  team:
                    status: "ok"
                    reasons: []
                    any_truncated: false
                    has_validation_issues: false
                    quality_overall: 7
                    source: "team"
                overallStatus: "risk"
                overallTone: "danger"
                any_truncated: true
                has_validation_issues: true
              is_complete: false
              missing_envelopes:
                - "explain"
                - "sensitivity"
              has_team_disagreement: true
            uiFlags:
              has_high_risk_envelopes: true
              has_team_disagreement: true
              has_truncation_somewhere: true
              is_journey_complete: false
            trace:
              request_id: "cee_req_golden_123"
              correlation_id: "cee_req_golden_123"

  headers:
    X-Deprecated-Provenance-Format:
      description: Indicates graph contains legacy string provenance
      schema:
        type: string
        enum: ["true"]

    X-Deprecation-Sunset:
      description: Date when legacy provenance format will be removed
      schema:
        type: string
        format: date
        example: "2025-12-01"

    X-Deprecation-Link:
      description: Link to provenance migration guide
      schema:
        type: string
        format: uri
        example: "https://docs.olumi.ai/provenance-migration"

    X-CEE-API-Version:
      description: CEE API version used to process the request
      schema:
        type: string
        enum: ["v1"]

    X-CEE-Feature-Version:
      description: Version of the CEE feature implementation
      schema:
        type: string

    X-CEE-Request-ID:
      description: Unique request identifier for CEE calls
      schema:
        type: string

  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication (if enabled)

security:
  - apiKey: []

x-rate-limits:
  global:
    limit: 120
    window: 60s
    per: ip
    note: "Configurable via GLOBAL_RATE_LIMIT_RPM"
  per-key:
    limit: 120
    window: 60s
    note: "Standard endpoints, configurable via RATE_LIMIT_RPM"
  sse:
    limit: 20
    window: 60s
    note: "SSE endpoints, configurable via SSE_RATE_LIMIT_RPM"

x-body-limits:
  max-size: 1MB

x-timeouts:
  request: 60s
  connection: 60s
