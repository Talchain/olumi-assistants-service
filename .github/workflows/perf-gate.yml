name: Performance Gate

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: perf-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  perf-gate:
    name: Performance Gate (p95 < 8s)
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      BASE_URL: https://olumi-assistants-service.onrender.com
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with: { version: 9 }

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run Artillery against production (always write JSON)
        env:
          ASSIST_API_KEY: ${{ secrets.ASSIST_API_KEY }}
        run: |
          set -euxo pipefail
          npx --yes artillery@2 run perf/perf.yml \
            --target "$BASE_URL" \
            -o perf-results.json || echo "ARTILLERY_FAILED=1" >> $GITHUB_ENV
          # Ensure artefact presence even if Artillery failed early
          [[ -f perf-results.json ]] || echo '{}' > perf-results.json

      - name: Enforce p95 < 8000ms on /healthz
        run: |
          node -e "
          const fs=require('fs');
          const p=JSON.parse(fs.readFileSync('perf-results.json','utf8'));
          const agg = p.aggregate || p.aggregates || {};
          let p95;
          // Try endpoint-specific metrics first (most accurate)
          if (agg.summaries?.['plugins.metrics-by-endpoint.response_time./healthz']?.p95) {
            p95 = agg.summaries['plugins.metrics-by-endpoint.response_time./healthz'].p95;
          }
          // Fallback to overall response time
          if (!p95 && agg.summaries?.['http.response_time']?.p95) {
            p95 = agg.summaries['http.response_time'].p95;
          }
          if (!p95) throw new Error('p95 not found in perf-results.json');
          console.log('healthz p95:', p95, 'ms');
          if (p95 > 8000) { throw new Error(\`p95 \${p95}ms > 8000ms (FAIL)\`); }
          console.log('✅ p95 gate passed');
          "

      - name: Summarise p95 (healthz + draft-graph if present)
        run: |
          node -e "
          const fs=require('fs');
          const p=JSON.parse(fs.readFileSync('perf-results.json','utf8'));
          const agg = p.aggregate || {};
          const healthz = agg.summaries?.['plugins.metrics-by-endpoint.response_time./healthz']?.p95 ?? 'n/a';
          const draft = agg.summaries?.['plugins.metrics-by-endpoint.response_time./assist/draft-graph']?.p95 ?? 'n/a';
          const overall = agg.summaries?.['http.response_time']?.p95 ?? 'n/a';
          const md = [
            '### Performance Gate Summary',
            '',
            '| Metric | p95 (ms) | Status |',
            '|---|---|---|',
            \`| /healthz (gating) | \${healthz} | \${healthz !== 'n/a' && healthz < 8000 ? '✅' : '❌'} |\`,
            \`| /assist/draft-graph (observe) | \${draft} | ℹ️ |\`,
            \`| Overall | \${overall} | - |\`
          ].join('\n');
          fs.writeFileSync(process.env.GITHUB_STEP_SUMMARY, md);
          "

      - name: Upload perf artefact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-results
          path: perf-results.json

      - name: Comment p95 on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true  # Don't fail job if comment fails due to permissions
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Performance Gate (production):**
            Results uploaded as artefact **perf-results**.
            See job summary for p95 values (healthz gating, draft-graph observed).
