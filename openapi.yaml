openapi: 3.0.3
info:
  title: Olumi Assistants Service API
  version: 1.2.1
  description: |
    AI-powered decision graph drafting service that transforms natural language briefs into structured,
    executable decision models with provenance tracking and validation.

    ## Features
    - **Structured Provenance**: Traceable citations to source documents with locations
    - **Streaming Support**: Server-Sent Events (SSE) for real-time progress updates
    - **LLM-Guided Repair**: Intelligent graph validation and auto-repair
    - **Security Rails**: Rate limiting, body size limits, request timeouts
    - **Deprecation Signals**: Migration support for legacy provenance formats

  contact:
    name: Olumi API Support
    url: https://docs.olumi.ai
    email: support@olumi.ai
  license:
    name: Proprietary

servers:
  - url: http://localhost:3101
    description: Local development
  - url: https://api.olumi.ai
    description: Production

tags:
  - name: Draft
    description: Graph drafting endpoints
  - name: Suggest
    description: Option suggestion endpoints
  - name: Explain
    description: Explanation and rationale endpoints
  - name: Health
    description: Service health check

paths:
  /healthz:
    get:
      summary: Health check
      description: |
        Returns service health status and configuration info.

        **Use for ops visibility:**
        - Service status and version
        - LLM provider and model configuration
        - Active feature flags (environment-level)
        - Graph limits source (engine vs config)
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - ok
                  - service
                  - version
                  - provider
                  - model
                  - limits_source
                  - feature_flags
                properties:
                  ok:
                    type: boolean
                    example: true
                  service:
                    type: string
                    example: "assistants"
                  version:
                    type: string
                    description: Service version (semver)
                    example: "1.1.0"
                  provider:
                    type: string
                    description: LLM provider in use
                    enum: [openai, anthropic, fixtures]
                    example: "anthropic"
                  model:
                    type: string
                    description: LLM model identifier
                    example: "claude-3-5-sonnet-20241022"
                  limits_source:
                    type: string
                    enum: [engine, config]
                    description: Where graph limits are sourced from
                  feature_flags:
                    type: object
                    description: Current feature flag values (environment-level)
                    properties:
                      grounding:
                        type: boolean
                        description: Document grounding enabled
                      critique:
                        type: boolean
                        description: Critique endpoint enabled
                      clarifier:
                        type: boolean
                        description: Clarifying questions enabled
                    example:
                      grounding: true
                      critique: true
                      clarifier: true

  /assist/draft-graph:
    post:
      summary: Draft decision graph (JSON or SSE)
      description: |
        Generates a decision graph from a natural language brief with optional document attachments.

        **Response Format:**
        - Default (JSON): Returns complete graph immediately
        - SSE: Include `Accept: text/event-stream` header for streaming updates

        **Note:** Use `/assist/draft-graph/stream` for dedicated SSE endpoint with better caching.
      tags:
        - Draft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftGraphInput'
            examples:
              basic:
                summary: Basic brief
                value:
                  brief: "Should we expand to international markets or focus on domestic growth?"
              with_attachments:
                summary: With document attachments
                value:
                  brief: "Based on the attached market analysis, develop a comprehensive growth strategy"
                  attachments:
                    - id: "doc_1"
                      kind: "pdf"
                      name: "market-analysis.pdf"
                  attachment_payloads:
                    doc_1: "base64encodedcontent..."
      responses:
        '200':
          description: Graph successfully generated
          headers:
            X-Deprecated-Provenance-Format:
              description: Present if graph contains legacy string provenance
              schema:
                type: string
                enum: ["true"]
            X-Deprecation-Sunset:
              description: Date when legacy format will be removed (if X-Deprecated-Provenance-Format present)
              schema:
                type: string
                format: date
                example: "2025-12-01"
            X-Deprecation-Link:
              description: Link to migration guide (if X-Deprecated-Provenance-Format present)
              schema:
                type: string
                format: uri
                example: "https://docs.olumi.ai/provenance-migration"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftGraphOutput'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEStream'
              example: |
                event: stage
                data: {"stage":"DRAFTING"}

                event: stage
                data: {"stage":"DRAFTING","payload":{"graph":{...},"patch":{...},"confidence":0.5}}

                event: stage
                data: {"stage":"COMPLETE","payload":{"graph":{...},"patch":{...},"confidence":0.87}}
        '400':
          $ref: '#/components/responses/BadInput'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /assist/draft-graph/stream:
    post:
      summary: Draft decision graph (SSE only)
      description: |
        Dedicated streaming endpoint that always returns Server-Sent Events (SSE).

        **Benefits over `/assist/draft-graph` with Accept header:**
        - Explicit URL for preflighting and caching
        - Clearer API surface
        - Better CDN/proxy support

        **Streaming Behavior:**
        - Initial `DRAFTING` event sent immediately
        - Fixture graph shown after 2.5s if LLM is still processing
        - Final `COMPLETE` event contains actual graph
      tags:
        - Draft
      requestBody:
        $ref: '#/components/requestBodies/DraftGraphRequest'
      responses:
        '200':
          description: SSE stream with graph generation progress
          headers:
            X-Deprecated-Provenance-Format:
              $ref: '#/components/headers/X-Deprecated-Provenance-Format'
            X-Deprecation-Sunset:
              $ref: '#/components/headers/X-Deprecation-Sunset'
            X-Deprecation-Link:
              $ref: '#/components/headers/X-Deprecation-Link'
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEStream'
              examples:
                successful_stream:
                  summary: Successful graph generation
                  value: |
                    event: stage
                    data: {"stage":"DRAFTING"}

                    event: stage
                    data: {"stage":"COMPLETE","payload":{"graph":{"version":"1","nodes":[...],"edges":[...]},"confidence":0.87}}

                with_fixture:
                  summary: Slow response with fixture fallback
                  value: |
                    event: stage
                    data: {"stage":"DRAFTING"}

                    event: stage
                    data: {"stage":"DRAFTING","payload":{"graph":{"meta":{"source":"fixtures"}...},"confidence":0.5}}

                    event: stage
                    data: {"stage":"COMPLETE","payload":{"graph":{"meta":{"source":"assistant"}...},"confidence":0.92}}
        '400':
          description: Invalid input (SSE error format)
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEErrorStream'
        '429':
          $ref: '#/components/responses/RateLimited'

  /assist/suggest-options:
    post:
      summary: Suggest strategic options for a goal
      description: |
        Generates 3-5 distinct strategic options for a given goal.

        **Features:**
        - Deterministic ordering (options sorted alphabetically by ID)
        - Optional constraint consideration
        - Can avoid duplicating existing options
        - Returns structured options with IDs, titles, and descriptions
      tags:
        - Suggest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuggestOptionsInput'
            examples:
              basic:
                summary: Basic goal
                value:
                  goal: "Increase customer retention"
              with_constraints:
                summary: With constraints and existing options
                value:
                  goal: "Reduce operational costs"
                  constraints:
                    budget: 100000
                    timeline: "Q1 2025"
                  graph_summary:
                    decision: "dec_1"
                    existing_options: ["Outsource IT", "Automate workflows"]
      responses:
        '200':
          description: Options successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestOptionsOutput'
        '400':
          $ref: '#/components/responses/BadInput'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /assist/explain-diff:
    post:
      summary: Explain changes in a graph patch
      description: |
        Generates rationales explaining why specific changes were made in a graph patch.

        **Features:**
        - Non-mutating (does not modify the graph)
        - Deterministic ordering (rationales sorted alphabetically by target)
        - Structured output with target IDs, explanations, and optional provenance
        - Requires at least one change in the patch
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainDiffInput'
            examples:
              basic:
                summary: Explain added nodes
                value:
                  patch:
                    adds:
                      nodes:
                        - id: "opt_premium"
                          kind: "option"
                          label: "Premium pricing strategy"
                      edges: []
                    updates: []
                    removes: []
                  brief: "We need to increase revenue while maintaining customer satisfaction"
              with_summary:
                summary: With graph context
                value:
                  patch:
                    adds:
                      nodes:
                        - id: "out_revenue"
                          kind: "outcome"
                          label: "Revenue impact +15%"
                      edges:
                        - from: "opt_premium"
                          to: "out_revenue"
                    updates: []
                    removes: []
                  brief: "Analyze pricing strategy impact"
                  graph_summary:
                    node_count: 8
                    edge_count: 10
      responses:
        '200':
          description: Rationales successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainDiffOutput'
        '400':
          $ref: '#/components/responses/BadInput'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /assist/v1/draft-graph:
    post:
      summary: Draft decision graph (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Draft My Model** endpoint.

        This endpoint drafts a decision graph from a natural language brief using
        the engine's canonical GraphV1 / GraphPatchV1 contracts and the CEE
        validation pipeline. The underlying graph and patch payloads are the
        same engine contracts used by `/assist/draft-graph`; CEE adds trace,
        quality, validation metadata and archetype classification on top.

        **Rate limiting (CEE‑specific):**
        - Default: 5 requests per 60 seconds per API key (or client IP fallback).
        - Configurable via `CEE_DRAFT_RATE_LIMIT_RPM`.
        - Exceeding this per‑feature limit returns `CEEErrorResponseV1` with
          `code="CEE_RATE_LIMIT"`, `retryable=true`, a `Retry-After` header,
          and `details.retry_after_seconds` describing when it is safe to retry.
      tags:
        - Draft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEDraftGraphRequestV1'
      responses:
        '200':
          description: Graph successfully generated (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Draft My Model feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEDraftGraphResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Draft My Model
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/team-perspectives:
    post:
      summary: Summarise team perspectives on a decision (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Team Perspectives** endpoint.

        This endpoint takes structured team stances (for/against/neutral) and
        returns a compact numeric summary of agreement vs disagreement. It does
        **not** process or return any free-text comments.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEETeamPerspectivesRequestV1'
      responses:
        '200':
          description: Team perspectives summarised (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Team Perspectives feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEETeamPerspectivesResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Team Perspectives
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/sensitivity-coach:
    post:
      summary: Suggest sensitivity directions for key drivers (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Sensitivity Coach** endpoint.

        This endpoint turns `InferenceResultsV1.explain.top_drivers` into a
        small, deterministic set of suggestions about which drivers to
        increase or decrease. It does **not** call any LLMs and only returns
        structured, ID-based suggestions.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEESensitivityCoachRequestV1'
      responses:
        '200':
          description: Sensitivity suggestions computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Sensitivity Coach feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEESensitivityCoachResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Sensitivity Coach
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/options:
    post:
      summary: Suggest structural decision options (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Options Helper** endpoint.

        This endpoint suggests structured decision options using simple,
        deterministic heuristics over the decision graph and optional
        archetype metadata. It does **not** call any LLMs and only returns
        structured suggestions.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEOptionsRequestV1'
      responses:
        '200':
          description: Options suggestions computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Options feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEOptionsResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Options
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/bias-check:
    post:
      summary: Analyse decision graph for potential biases (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Bias Checker** endpoint.

        This endpoint inspects a decision graph (and optional archetype
        metadata) using simple, deterministic heuristics to surface
        potential sources of bias. It does **not** call any LLMs and only
        returns structured findings.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEBiasCheckRequestV1'
      responses:
        '200':
          description: Bias findings computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Bias Checker feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEBiasCheckResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Bias Checker
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/evidence-helper:
    post:
      summary: Score evidence items (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Evidence Helper** endpoint.

        This endpoint scores evidence items with simple, deterministic
        strength and relevance signals that can be reused across CEE
        experiences. It does **not** inspect or log raw evidence content;
        only structured, non-PII metadata is used.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEEvidenceHelperRequestV1'
      responses:
        '200':
          description: Evidence strengths computed (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Evidence Helper feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEEvidenceHelperResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Evidence Helper
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '503':
          description: CEE service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

  /assist/v1/explain-graph:
    post:
      summary: Explain decision graph (CEE v1)
      description: |
        Cognitive Enhancement Engine (CEE) v1 **Explain My Model** endpoint.

        This endpoint provides a structured explanation of a decision graph
        using the engine's canonical `Graph` contract together with
        `InferenceResultsV1` (report.v1 alias). CEE adds trace, quality,
        validation metadata and a structured `explanation` object on top.

        For v1 this endpoint is deterministic and does not perform additional
        LLM calls; it derives explanations directly from the supplied
        inference payload.
      tags:
        - Explain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CEEExplainGraphRequestV1'
      responses:
        '200':
          description: Explanation successfully generated (CEE v1)
          headers:
            X-CEE-API-Version:
              description: CEE API version used to process this request.
              schema:
                type: string
                enum: ["v1"]
            X-CEE-Feature-Version:
              description: Version of the CEE Explain Graph feature.
              schema:
                type: string
            X-CEE-Request-ID:
              description: Unique request identifier for CEE tracing.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEExplainGraphResponseV1'
        '400':
          description: CEE validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '429':
          description: CEE per-feature rate limit exceeded for Explain Graph
          headers:
            Retry-After:
              description: Seconds until the client may retry this request.
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'
        '500':
          description: CEE internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CEEErrorResponseV1'

components:
  schemas:
    DraftGraphInput:
      type: object
      required:
        - brief
      properties:
        brief:
          type: string
          minLength: 30
          maxLength: 5000
          description: Natural language description of the decision to model
          example: "Should we migrate to microservices or keep the monolith? Consider cost, team size, and time to market."
        attachments:
          type: array
          description: |
            Optional document attachments for context (PDF, CSV, TXT, MD).

            **Limits:**
            - Per-file: 5,000 characters maximum
            - Aggregate: 50,000 characters maximum across all files
            - Exceeding limits returns 400 BAD_INPUT with actionable hints
          items:
            $ref: '#/components/schemas/Attachment'
        attachment_payloads:
          type: object
          description: |
            Base64-encoded content for each attachment.

            **Format:**
            - String: Direct base64-encoded content
            - Object: `{data: string, encoding: "base64"}`

            Whitespace in base64 strings is automatically stripped during validation.
          additionalProperties:
            oneOf:
              - type: string
                description: Base64-encoded content
              - type: object
                properties:
                  data:
                    type: string
                  encoding:
                    type: string
                    default: base64
        constraints:
          type: object
          description: Optional constraints (reserved for future use)
          additionalProperties: true
        flags:
          type: object
          description: |
            Per-request feature flag overrides.

            **Available flags:**
            - `grounding`: Enable/disable document grounding (env: ENABLE_GROUNDING, default: true)
            - `critique`: Enable/disable critique endpoint (env: ENABLE_CRITIQUE, default: true)
            - `clarifier`: Enable/disable clarifying questions (env: ENABLE_CLARIFIER, default: true)

            **Priority:** Per-request flag > Environment variable > Default value

            **Example:** `{"flags": {"grounding": false}}` disables grounding for this request only
          additionalProperties:
            type: boolean
        include_debug:
          type: boolean
          description: Include debug information in response
          default: false
      additionalProperties: false

    Attachment:
      type: object
      required:
        - id
        - kind
        - name
      properties:
        id:
          type: string
          description: Unique identifier for this attachment
          example: "doc_1"
        kind:
          type: string
          enum: [pdf, csv, txt, md]
          description: Document type
        name:
          type: string
          description: Original filename
          example: "market-analysis.pdf"

    DraftGraphOutput:
      type: object
      required:
        - graph
        - patch
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        patch:
          $ref: '#/components/schemas/GraphPatch'
        rationales:
          type: array
          description: Explanations for graph elements
          items:
            type: object
            properties:
              target:
                type: string
                description: Node or edge ID being explained
              why:
                type: string
                maxLength: 280
                description: Brief explanation
              provenance_source:
                type: string
                description: Optional citation source
        issues:
          type: array
          description: Validation warnings (if any)
          items:
            type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence score for the generated graph
          example: 0.87
        clarifier_status:
          type: string
          enum: [complete, max_rounds, confident]
          description: Whether clarification questions are needed
        debug:
          type: object
          description: Debug information (only if include_debug=true)
          properties:
            needle_movers:
              type: array
              description: Document preview metadata
              items:
                type: object

    SuggestOptionsInput:
      type: object
      required:
        - goal
      properties:
        goal:
          type: string
          minLength: 5
          description: The goal or objective to generate options for
          example: "Increase customer retention rate"
        constraints:
          type: object
          description: Optional constraints to consider when generating options
          additionalProperties: true
          example:
            budget: 100000
            timeline: "Q1 2025"
        graph_summary:
          type: object
          description: Optional context about existing graph state
          properties:
            decision:
              type: string
              description: Decision node ID
            existing_options:
              type: array
              items:
                type: string
              description: List of existing option labels to avoid duplicating
        include_debug:
          type: boolean
          description: Include debug information in response
          default: false
      additionalProperties: false

    SuggestOptionsOutput:
      type: object
      required:
        - options
      properties:
        options:
          type: array
          minItems: 3
          maxItems: 5
          description: Generated strategic options (sorted alphabetically by ID)
          items:
            type: object
            required:
              - id
              - title
              - description
            properties:
              id:
                type: string
                minLength: 1
                description: Unique identifier for this option
                example: "opt_premium_pricing"
              title:
                type: string
                minLength: 3
                maxLength: 120
                description: Short title for the option
                example: "Premium Pricing Strategy"
              description:
                type: string
                minLength: 10
                maxLength: 500
                description: Detailed description of the option
                example: "Increase prices by 20% while adding premium features and personalized support to justify the higher cost"

    ExplainDiffInput:
      type: object
      required:
        - patch
      properties:
        patch:
          type: object
          description: Graph patch containing changes to explain
          properties:
            adds:
              type: object
              description: Added nodes and edges
              properties:
                nodes:
                  type: array
                  items:
                    type: object
                  default: []
                edges:
                  type: array
                  items:
                    type: object
                  default: []
              default:
                nodes: []
                edges: []
            updates:
              type: array
              description: Updated nodes
              items:
                type: object
              default: []
            removes:
              type: array
              description: Removed node/edge IDs
              items:
                type: string
              default: []
        brief:
          type: string
          description: Optional context about what the user is trying to achieve
          example: "We need to reduce costs while maintaining quality"
        graph_summary:
          type: object
          description: Optional summary of the current graph state
          properties:
            node_count:
              type: number
              description: Total number of nodes in the graph
            edge_count:
              type: number
              description: Total number of edges in the graph
      additionalProperties: false

    ExplainDiffOutput:
      type: object
      required:
        - rationales
      properties:
        rationales:
          type: array
          minItems: 1
          description: Explanations for each change (sorted alphabetically by target)
          items:
            type: object
            required:
              - target
              - why
            properties:
              target:
                type: string
                description: Node or edge ID being explained
                example: "opt_premium"
              why:
                type: string
                maxLength: 280
                description: Brief explanation of why this change was made
                example: "Premium pricing aligns with the goal of increasing revenue while maintaining brand positioning"
              provenance_source:
                type: string
                description: Optional citation to source document that influenced this change
                example: "market-analysis.pdf page 3"

    Graph:
      type: object
      required:
        - version
        - nodes
        - edges
      properties:
        version:
          type: string
          default: "1"
          description: Graph schema version
        default_seed:
          type: number
          default: 17
          description: Random seed for deterministic execution
        nodes:
          type: array
          maxItems: 12
          description: Graph nodes (max 12)
          items:
            $ref: '#/components/schemas/Node'
        edges:
          type: array
          maxItems: 24
          description: Graph edges (max 24)
          items:
            $ref: '#/components/schemas/Edge'
        meta:
          type: object
          description: Graph metadata
          properties:
            roots:
              type: array
              items:
                type: string
              description: Root node IDs
            leaves:
              type: array
              items:
                type: string
              description: Leaf node IDs
            suggested_positions:
              type: object
              description: Layout hints for UI
              additionalProperties:
                type: object
                properties:
                  x:
                    type: number
                  y:
                    type: number
            source:
              type: string
              enum: [assistant, fixtures]
              description: Origin of this graph

    Node:
      type: object
      required:
        - id
        - kind
      properties:
        id:
          type: string
          minLength: 1
          description: Unique node identifier
          example: "goal_1"
        kind:
          type: string
          enum: [goal, decision, option, outcome, risk, action]
          description: Node type
        label:
          type: string
          description: Human-readable label
          example: "Increase revenue by 25%"
        body:
          type: string
          maxLength: 200
          description: Optional detailed description

    Edge:
      type: object
      required:
        - from
        - to
      properties:
        id:
          type: string
          description: Optional edge identifier
        from:
          type: string
          description: Source node ID
        to:
          type: string
          description: Target node ID
        weight:
          type: number
          description: Edge weight (impact magnitude)
        belief:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence in this connection
          example: 0.85
        provenance:
          oneOf:
            - $ref: '#/components/schemas/StructuredProvenance'
            - type: string
              description: Legacy string provenance (deprecated)
              deprecated: true
          description: Citation for this edge
        provenance_source:
          type: string
          enum: [document, metric, hypothesis, engine]
          description: Type of provenance source

    StructuredProvenance:
      type: object
      required:
        - source
        - quote
      properties:
        source:
          type: string
          minLength: 1
          description: Source identifier (filename, metric name, or "hypothesis")
          example: "market-analysis.pdf"
        quote:
          type: string
          maxLength: 100
          description: Short citation or statement
          example: "Revenue grew 23% YoY"
        location:
          type: string
          description: Specific location within source (e.g., "page 12", "row 42", "line 156")
          example: "page 12"

    GraphPatch:
      type: object
      description: Incremental graph changes (for diff view)
      properties:
        adds:
          type: object
          properties:
            nodes:
              type: array
              items:
                $ref: '#/components/schemas/Node'
            edges:
              type: array
              items:
                $ref: '#/components/schemas/Edge'
        updates:
          type: array
          items:
            type: object
        removes:
          type: array
          items:
            type: object

    InferenceResultsV1:
      type: object
      description: Engine inference results (alias for report.v1) used by CEE explain endpoints
      required:
        - summary
        - seed
        - response_hash
      properties:
        summary:
          type: string
          description: Short natural language summary of inference results
        explain:
          type: object
          description: Optional explanation details such as top drivers
          properties:
            top_drivers:
              type: array
              items:
                type: object
                properties:
                  node_id:
                    type: string
                  description:
                    type: string
                  contribution:
                    type: number
        model_card:
          type: object
          description: Optional engine/model metadata
          additionalProperties: true
        seed:
          type: string
          description: Seed used by the engine for this inference
        response_hash:
          type: string
          description: Engine-provided response hash for reproducibility

    CEETraceMeta:
      type: object
      description: Trace metadata for CEE responses
      properties:
        request_id:
          type: string
          description: Unique request identifier
        correlation_id:
          type: string
          description: Correlates to server logs and telemetry
        engine:
          type: object
          description: Engine-level trace information
          properties:
            provider:
              type: string
            model:
              type: string
            version:
              type: string
            response_hash:
              type: string
            degraded:
              type: boolean
        details:
          type: object
          description: Additional trace metadata
          additionalProperties: true

    CEEValidationIssue:
      type: object
      description: Validation issue discovered in the CEE pipeline
      required:
        - code
        - severity
      properties:
        code:
          type: string
        severity:
          type: string
          enum: [info, warning, error]
        field:
          type: string
          description: Optional field or path this issue relates to
        message:
          type: string
          description: Human-readable description for clients (not logged as telemetry)
        details:
          type: object
          additionalProperties: true

    CEEGuidanceV1:
      type: object
      description: |
        High-level user guidance derived from quality, validation_issues, and (where applicable) response_limits.
        Intended for UI hints and summaries rather than core programmatic logic.
      required:
        - summary
      properties:
        summary:
          type: string
          description: Short overview of model quality and any notable limitations.
        risks:
          type: array
          description: Concise risk or gap statements derived from validation issues and truncation flags.
          items:
            type: string
        next_actions:
          type: array
          description: Suggested next actions to improve confidence in the decision.
          items:
            type: string
        any_truncated:
          type: boolean
          description: True if any truncation flag in response_limits is set.

    ErrorV1:
      type: object
      description: Generic error response schema for non-CEE endpoints and SSE helpers
      required:
        - schema
        - code
        - message
      properties:
        schema:
          type: string
          enum: [error.v1]
        code:
          type: string
          enum: [BAD_INPUT, RATE_LIMITED, INTERNAL]
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error context
          additionalProperties: true

    CEEQualityMeta:
      type: object
      description: Quality scores for CEE outputs (1-10 scale)
      required:
        - overall
      properties:
        overall:
          type: integer
          minimum: 1
          maximum: 10
        structure:
          type: integer
          minimum: 1
          maximum: 10
        causality:
          type: integer
          minimum: 1
          maximum: 10
        coverage:
          type: integer
          minimum: 1
          maximum: 10
        safety:
          type: integer
          minimum: 1
          maximum: 10
        details:
          type: object
          additionalProperties: true

    CEEErrorCode:
      type: string
      description: Machine-readable CEE error code
      enum:
        - CEE_TIMEOUT
        - CEE_RATE_LIMIT
        - CEE_GRAPH_INVALID
        - CEE_VALIDATION_FAILED
        - CEE_INTERNAL_ERROR
        - CEE_SERVICE_UNAVAILABLE
        - CEE_ENGINE_DEGRADED
        - CEE_REPRO_MISMATCH

    CEEErrorResponseV1:
      type: object
      description: Error response schema for CEE endpoints
      required:
        - schema
        - code
        - message
      properties:
        schema:
          type: string
          enum: [cee.error.v1]
        code:
          $ref: '#/components/schemas/CEEErrorCode'
        message:
          type: string
          description: Human-readable error message
        retryable:
          type: boolean
          description: Whether the client may safely retry this request
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        details:
          type: object
          additionalProperties: true

    CEEDraftGraphRequestV1:
      allOf:
        - $ref: '#/components/schemas/DraftGraphInput'
        - type: object
          properties:
            seed:
              type: string
              description: Optional client-provided seed for deterministic behaviour
            archetype_hint:
              type: string
              description: Optional hint for the target archetype, e.g. pricing_decision

    CEEExplainGraphRequestV1:
      type: object
      description: CEE explain-graph request payload
      required:
        - graph
        - inference
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        inference:
          type: object
          required:
            - summary
            - seed
            - response_hash
          properties:
            summary:
              type: string
              description: Short summary of the inference run.
            explain:
              type: object
              description: Optional explainability metadata used to derive explanations.
              properties:
                top_drivers:
                  type: array
                  items:
                    type: object
                    required:
                      - node_id
                    properties:
                      node_id:
                        type: string
                      description:
                        type: string
                      contribution:
                        type: number
                  default: []
            model_card:
              type: object
              additionalProperties: true
              description: Optional model metadata blob.
            seed:
              type: string
            response_hash:
              type: string
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEEEvidenceItemRequestV1:
      type: object
      description: Evidence item provided by the client for strength scoring
      required:
        - id
        - type
      properties:
        id:
          type: string
          description: Opaque evidence identifier
        type:
          type: string
          description: Evidence kind (see enum for recommended values)
          enum: [experiment, user_research, market_data, expert_opinion, other]
        source:
          type: string
          description: Optional short source code (not logged in telemetry)
        content:
          type: string
          description: Optional raw evidence content (never logged or emitted in telemetry)

    CEEEvidenceItemResponseV1:
      type: object
      description: Evidence item with computed strength metadata
      required:
        - id
        - type
        - strength
      properties:
        id:
          type: string
        type:
          type: string
        strength:
          type: string
          enum: [none, weak, medium, strong]
        relevance:
          type: string
          enum: [low, medium, high]

    CEEEvidenceHelperRequestV1:
      type: object
      description: CEE evidence helper request payload
      required:
        - evidence
      properties:
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/CEEEvidenceItemRequestV1'

    CEEBiasCheckRequestV1:
      type: object
      description: CEE bias check request payload
      required:
        - graph
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        archetype:
          type: object
          description: Optional archetype metadata from a previous draft run
          properties:
            decision_type:
              type: string
            match:
              type: string
              enum: [exact, fuzzy, generic]
            confidence:
              type: number
              minimum: 0
              maximum: 1
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEEOptionsRequestV1:
      type: object
      description: CEE options helper request
      required:
        - graph
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        archetype:
          type: object
          description: Optional archetype metadata from a previous draft run
          properties:
            decision_type:
              type: string
            match:
              type: string
              enum: [exact, fuzzy, generic]
            confidence:
              type: number
              minimum: 0
              maximum: 1
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEEDraftGraphResponseV1:
      allOf:
        - $ref: '#/components/schemas/DraftGraphOutput'
        - type: object
          required:
            - trace
            - quality
          properties:
            trace:
              $ref: '#/components/schemas/CEETraceMeta'
            quality:
              $ref: '#/components/schemas/CEEQualityMeta'
            validation_issues:
              type: array
              items:
                $ref: '#/components/schemas/CEEValidationIssue'
            archetype:
              type: object
              description: Archetype classification metadata
              properties:
                decision_type:
                  type: string
                  description: Classified decision type, e.g. pricing_decision
                match:
                  type: string
                  enum: [exact, fuzzy, generic]
                confidence:
                  type: number
                  minimum: 0
                  maximum: 1
            seed:
              type: string
              description: Seed value used for this response
            response_hash:
              type: string
              description: Engine-provided response hash for reproducibility
            response_limits:
              type: object
              properties:
                bias_findings_max:
                  type: integer
                bias_findings_truncated:
                  type: boolean
                options_max:
                  type: integer
                options_truncated:
                  type: boolean
                evidence_suggestions_max:
                  type: integer
                evidence_suggestions_truncated:
                  type: boolean
                sensitivity_suggestions_max:
                  type: integer
                sensitivity_suggestions_truncated:
                  type: boolean
            guidance:
              $ref: '#/components/schemas/CEEGuidanceV1'

    CEEExplainGraphResponseV1:
      type: object
      description: Structured explanation for a decision graph
      required:
        - trace
        - quality
        - explanation
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'
        explanation:
          type: object
          description: Structured explanation derived from inference results
          properties:
            targets:
              type: object
              additionalProperties:
                type: object
                properties:
                  summary:
                    type: string
                  p10:
                    type: number
                  p50:
                    type: number
                  p90:
                    type: number
            top_drivers:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  impact:
                    type: number
                  rank:
                    type: integer
                  label:
                    type: string

    CEEEvidenceHelperResponseV1:
      type: object
      description: CEE evidence helper response with strength scores
      required:
        - trace
        - quality
        - items
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        items:
          type: array
          items:
            $ref: '#/components/schemas/CEEEvidenceItemResponseV1'
        response_limits:
          type: object
          description: Response caps applied to evidence items, if any
          properties:
            items_max:
              type: integer
              description: Maximum number of items returned
              example: 20
            items_truncated:
              type: boolean
              description: Whether items was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEEBiasFindingV1:
      type: object
      description: Bias or fairness-related finding detected by CEE
      required:
        - id
        - category
        - severity
      properties:
        id:
          type: string
          description: Stable identifier for this finding type
        category:
          type: string
          enum: [selection, measurement, optimisation, framing, other]
        severity:
          type: string
          enum: [low, medium, high]
        node_ids:
          type: array
          description: Related graph node IDs (no labels or free text)
          items:
            type: string
        explanation:
          type: string
          description: Short human-readable explanation (not used in telemetry)

    CEEBiasCheckResponseV1:
      type: object
      description: Structured bias findings for a decision graph
      required:
        - trace
        - quality
        - bias_findings
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        bias_findings:
          type: array
          items:
            $ref: '#/components/schemas/CEEBiasFindingV1'
        response_limits:
          type: object
          description: Response caps applied to bias findings, if any
          properties:
            bias_findings_max:
              type: integer
              description: Maximum number of bias findings returned
              example: 10
            bias_findings_truncated:
              type: boolean
              description: Whether bias_findings was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEEOptionV1:
      type: object
      description: Structured decision option suggested by CEE
      required:
        - id
        - kind
      properties:
        id:
          type: string
          description: Stable identifier for this option suggestion
        kind:
          type: string
          enum: [expand_scope, reduce_scope, change_channel, adjust_timing, other]
        node_ids:
          type: array
          description: Related graph node IDs (no labels or free text)
          items:
            type: string
        priority:
          type: string
          description: Relative importance or urgency of this option
          enum: [low, medium, high]
        explanation:
          type: string
          description: Short human-readable explanation (not used in telemetry)

    CEEOptionsResponseV1:
      type: object
      description: Structured options suggestions for a decision graph
      required:
        - trace
        - quality
        - options
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        options:
          type: array
          items:
            $ref: '#/components/schemas/CEEOptionV1'
        response_limits:
          type: object
          description: Response caps applied to options list, if any
          properties:
            options_max:
              type: integer
              description: Maximum number of options returned
            options_truncated:
              type: boolean
              description: Whether options list was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEESensitivityCoachRequestV1:
      type: object
      description: CEE sensitivity coach request payload
      required:
        - graph
        - inference
      properties:
        graph:
          $ref: '#/components/schemas/Graph'
        inference:
          type: object
          required:
            - summary
            - seed
            - response_hash
          properties:
            summary:
              type: string
              description: Short summary of the inference run.
            explain:
              type: object
              description: Optional explainability metadata used to derive suggestions.
              properties:
                top_drivers:
                  type: array
                  items:
                    type: object
                    required:
                      - node_id
                    properties:
                      node_id:
                        type: string
                      description:
                        type: string
                      contribution:
                        type: number
                  default: []
            model_card:
              type: object
              additionalProperties: true
              description: Optional model metadata blob.
            seed:
              type: string
            response_hash:
              type: string
        context_id:
          type: string
          description: Optional opaque context identifier (not logged in telemetry).

    CEESensitivitySuggestionV1:
      type: object
      description: Deterministic sensitivity suggestion derived from inference top drivers.
      required:
        - driver_id
        - rank
      properties:
        driver_id:
          type: string
          description: ID of the driver node in the graph.
        rank:
          type: integer
          minimum: 1
          description: Ordering of this suggestion (1 is the strongest driver).
        direction:
          type: string
          enum: [increase, decrease]
          description: Suggested direction to probe (increase/decrease). Absent when contribution is 0.
        target_id:
          type: string
          description: Optional target node for further analysis (reserved for future versions).

    CEESensitivityCoachResponseV1:
      type: object
      description: Structured sensitivity coaching for a decision graph
      required:
        - trace
        - quality
        - sensitivity_suggestions
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        sensitivity_suggestions:
          type: array
          items:
            $ref: '#/components/schemas/CEESensitivitySuggestionV1'
        response_limits:
          type: object
          description: Response caps applied to sensitivity suggestions, if any
          properties:
            sensitivity_suggestions_max:
              type: integer
              description: Maximum number of suggestions returned
            sensitivity_suggestions_truncated:
              type: boolean
              description: Whether sensitivity_suggestions was truncated to the cap
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    CEETeamPerspectiveItemV1:
      type: object
      description: Individual team perspective item
      required:
        - id
        - stance
      properties:
        id:
          type: string
          description: Opaque participant identifier
        stance:
          type: string
          enum: [for, against, neutral]
        weight:
          type: number
          description: Optional positive weight for this participant (0 or negative values are treated as 0).
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Optional confidence in this stance.

    CEETeamPerspectivesRequestV1:
      type: object
      description: CEE team perspectives request payload
      required:
        - perspectives
      properties:
        perspectives:
          type: array
          items:
            $ref: '#/components/schemas/CEETeamPerspectiveItemV1'
        context_id:
          type: string
          description: Optional opaque context/brief identifier (not logged in telemetry).

    CEETeamPerspectivesSummaryV1:
      type: object
      description: Aggregated summary of team perspectives.
      required:
        - participant_count
        - for_count
        - against_count
        - neutral_count
        - disagreement_score
      properties:
        participant_count:
          type: integer
          description: Total number of participants.
        for_count:
          type: integer
          description: Number of participants with stance "for".
        against_count:
          type: integer
          description: Number of participants with stance "against".
        neutral_count:
          type: integer
          description: Number of participants with stance "neutral".
        weighted_for_fraction:
          type: number
          minimum: 0
          maximum: 1
          description: Weighted fraction of "for" stances; neutrals are included in the denominator.
        disagreement_score:
          type: number
          minimum: 0
          maximum: 1
          description: 0 means everyone is aligned on the same stance; higher values indicate more disagreement.
        has_team_disagreement:
          type: boolean
          description: |
            True when disagreement_score is above an internal threshold and there are enough
            participants to consider the disagreement material. Exposed as a convenience flag
            for UIs; always derived from existing summary metadata.

    CEETeamPerspectivesResponseV1:
      type: object
      description: CEE team perspectives response
      required:
        - trace
        - quality
        - summary
      properties:
        trace:
          $ref: '#/components/schemas/CEETraceMeta'
        quality:
          $ref: '#/components/schemas/CEEQualityMeta'
        validation_issues:
          type: array
          items:
            $ref: '#/components/schemas/CEEValidationIssue'
        summary:
          $ref: '#/components/schemas/CEETeamPerspectivesSummaryV1'
        guidance:
          $ref: '#/components/schemas/CEEGuidanceV1'

    DecisionStorySummaryV1:
      type: object
      description: High-level decision story summary derived from CEE envelopes.
      required:
        - headline
        - key_drivers
        - risks_and_gaps
        - next_actions
        - any_truncated
      properties:
        headline:
          type: string
          description: Short narrative summary of the decision and CEE judgement.
        key_drivers:
          type: array
          description: Concise, content-free drivers behind the decision posture.
          items:
            type: string
        risks_and_gaps:
          type: array
          description: High-level risks or gaps surfaced by CEE (no user text).
          items:
            type: string
        next_actions:
          type: array
          description: Suggested next actions to improve confidence in the decision.
          items:
            type: string
        any_truncated:
          type: boolean
          description: True when any underlying CEE envelope applied deterministic caps.
        quality_overall:
          type: integer
          minimum: 1
          maximum: 10
          description: Overall quality score (1–10) mirrored from CEEQualityMeta.overall.

    CeeHealthSummaryV1:
      type: object
      description: Per-envelope health summary derived from CEE metadata.
      required:
        - status
        - reasons
        - any_truncated
        - has_validation_issues
        - source
      properties:
        status:
          type: string
          enum: [ok, warning, risk]
        reasons:
          type: array
          items:
            type: string
        any_truncated:
          type: boolean
        has_validation_issues:
          type: boolean
        quality_overall:
          type: integer
          minimum: 1
          maximum: 10
        source:
          type: string
          enum: [draft, explain, evidence, bias, options, sensitivity, team]

    CeeJourneyHealthV1:
      type: object
      description: Aggregated journey-level health across CEE envelopes.
      required:
        - perEnvelope
        - overallStatus
        - overallTone
        - any_truncated
        - has_validation_issues
      properties:
        perEnvelope:
          type: object
          properties:
            draft:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            explain:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            evidence:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            bias:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            options:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            sensitivity:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
            team:
              $ref: '#/components/schemas/CeeHealthSummaryV1'
        overallStatus:
          type: string
          enum: [ok, warning, risk]
        overallTone:
          type: string
          enum: [success, warning, danger]
        any_truncated:
          type: boolean
        has_validation_issues:
          type: boolean

    CeeJourneySummaryV1:
      type: object
      description: Combined decision story and health summary for a CEE journey.
      required:
        - story
        - health
        - is_complete
        - missing_envelopes
        - has_team_disagreement
      properties:
        story:
          $ref: '#/components/schemas/DecisionStorySummaryV1'
        health:
          $ref: '#/components/schemas/CeeJourneyHealthV1'
        is_complete:
          type: boolean
        missing_envelopes:
          type: array
          items:
            type: string
            enum: [draft, explain, evidence, bias, options, sensitivity, team]
        has_team_disagreement:
          type: boolean

    CeeUiFlagsV1:
      type: object
      description: High-level UI flags derived from the journey summary.
      required:
        - has_high_risk_envelopes
        - has_team_disagreement
        - has_truncation_somewhere
        - is_journey_complete
      properties:
        has_high_risk_envelopes:
          type: boolean
        has_team_disagreement:
          type: boolean
        has_truncation_somewhere:
          type: boolean
        is_journey_complete:
          type: boolean

    CeeDecisionReviewPayloadV1:
      type: object
      description: Compact, metadata-only Decision Review payload (story, journey, uiFlags, trace).
      required:
        - story
        - journey
        - uiFlags
      properties:
        story:
          $ref: '#/components/schemas/DecisionStorySummaryV1'
        journey:
          $ref: '#/components/schemas/CeeJourneySummaryV1'
        uiFlags:
          $ref: '#/components/schemas/CeeUiFlagsV1'
        trace:
          type: object
          description: Optional trace identifiers (request/correlation IDs only).
          properties:
            request_id:
              type: string
            correlation_id:
              type: string

    SSEStream:
      type: object
      description: Server-Sent Events stream format
      properties:
        event:
          type: string
          enum: [stage]
          description: Event type (always "stage" for graph drafting)
        data:
          oneOf:
            - $ref: '#/components/schemas/SSEDraftingEvent'
            - $ref: '#/components/schemas/SSECompleteEvent'

    SSEDraftingEvent:
      type: object
      required:
        - stage
      properties:
        stage:
          type: string
          enum: [DRAFTING]
        payload:
          $ref: '#/components/schemas/DraftGraphOutput'
          description: Optional fixture graph (shown after 2.5s timeout)

    SSECompleteEvent:
      type: object
      required:
        - stage
        - payload
      properties:
        stage:
          type: string
          enum: [COMPLETE]
        payload:
          oneOf:
            - $ref: '#/components/schemas/DraftGraphOutput'
            - $ref: '#/components/schemas/ErrorV1'

    SSEErrorStream:
      type: object
      properties:
        event:
          type: string
          enum: [stage]
        data:
          type: object
          properties:
            stage:
              type: string
              enum: [COMPLETE]
            payload:
              $ref: '#/components/schemas/ErrorV1'

  requestBodies:
    DraftGraphRequest:
      description: Graph drafting request
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DraftGraphInput'

  responses:
    BadInput:
      description: Invalid input data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "BAD_INPUT"
            message: "invalid input"
            details:
              fieldErrors:
                brief: ["String must contain at least 30 character(s)"]

    PayloadTooLarge:
      description: Request payload exceeds 1 MB limit
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "BAD_INPUT"
            message: "Request payload too large"
            details:
              limit_bytes: 1048576

    RateLimited:
      description: Rate limit exceeded (10 requests per minute per IP)
      headers:
        X-RateLimit-Limit:
          description: Request limit per window
          schema:
            type: integer
            example: 10
        X-RateLimit-Remaining:
          description: Requests remaining in current window
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          description: Time when rate limit resets (Unix timestamp)
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "RATE_LIMITED"
            message: "Rate limit exceeded"
            details:
              max: 10
              window_ms: 60000

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorV1'
          example:
            schema: "error.v1"
            code: "INTERNAL"
            message: "internal server error"

  headers:
    X-Deprecated-Provenance-Format:
      description: Indicates graph contains legacy string provenance
      schema:
        type: string
        enum: ["true"]

    X-Deprecation-Sunset:
      description: Date when legacy provenance format will be removed
      schema:
        type: string
        format: date
        example: "2025-12-01"

    X-Deprecation-Link:
      description: Link to provenance migration guide
      schema:
        type: string
        format: uri
        example: "https://docs.olumi.ai/provenance-migration"

    X-CEE-API-Version:
      description: CEE API version used to process the request
      schema:
        type: string
        enum: ["v1"]

    X-CEE-Feature-Version:
      description: Version of the CEE feature implementation
      schema:
        type: string

    X-CEE-Request-ID:
      description: Unique request identifier for CEE calls
      schema:
        type: string

  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication (if enabled)

security:
  - apiKey: []

x-rate-limits:
  draft-graph:
    limit: 10
    window: 60s
    per: ip

x-body-limits:
  max-size: 1MB

x-timeouts:
  request: 60s
  connection: 60s
